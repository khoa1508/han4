<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyá»‡n Tiáº¿ng Trung Vui Váº» ğŸ¼ (Gemini Flash + Google Form v2)</title>
    <style>
        /* ----- CSS khÃ´ng Ä‘á»•i ----- */
        body { font-family: sans-serif; line-height: 1.6; background-color: #f0f8ff; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; margin: 0; }
        #game-container { background-color: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); max-width: 800px; width: 100%; text-align: center; box-sizing: border-box; }
        h1 { color: #ff6347; margin-top: 0; }
        #timer-section { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #4682b4; }
        #instructions p { background-color: #e0f7fa; border-left: 5px solid #00bcd4; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: left; }
        #game-area { margin-bottom: 20px; text-align: left; }
        #current-word-area { margin-bottom: 20px; padding: 15px; background-color: #fffacd; border-radius: 8px; text-align: center; }
        #current-word-hanzi { font-size: 1.8em; font-weight: bold; display: block; margin-bottom: 5px;}
        #current-word-pinyin { font-size: 1.1em; color: grey; display: block;}
        #sentence-input { box-sizing: border-box; width: 100%; padding: 15px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; min-height: 80px; margin-bottom: 15px; display: block; }
        .paragraph-container { font-size: 1.2em; line-height: 1.8; margin-bottom: 20px; background-color: #f8f8f8; padding: 20px; border-radius: 8px; border: 1px solid #eee; text-align: left; }
        .blank-input { width: auto; min-width: 50px; border: none; border-bottom: 2px solid #4682b4; padding: 2px 5px; font-size: 1em; text-align: center; margin: 0 3px; background-color: transparent; vertical-align: baseline; }
        .new-word { color: red; font-weight: bold; cursor: pointer; position: relative; }
        .tooltip { display: none; position: absolute; background-color: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; z-index: 10; white-space: normal; max-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: left; }
        .tooltip span { display: block; margin-bottom: 3px; }
        .tooltip span:last-child { margin-bottom: 0; }
        #hint-section { margin-bottom: 20px; }
        #hint-text { color: #6a5acd; font-style: italic; min-height: 20px; margin-top: 10px; }
        #feedback-section { margin-top: 15px; padding: 10px; border-radius: 5px; min-height: 30px; display: none; word-wrap: break-word; text-align: left; }
        #feedback-section.correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #feedback-section.incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #feedback-section.info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        button { background-color: #ff6347; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease, transform 0.1s ease; margin: 10px 5px 5px 5px; }
        button:hover { background-color: #e5533d; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #summary-page { background-color: #e6f7ff; padding: 30px; border-radius: 10px; margin-top: 20px; text-align: left; display: none; }
        #summary-page h2 { text-align: center; color: #1890ff; }
        #summary-errors { padding-left: 20px; }
        #summary-errors li { color: #d9534f; margin-bottom: 5px; list-style: disc; }
        #summary-errors small { color: #555; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Ã”n táº­p tiáº¿ng Trung cÃ¹ng AI ğŸš€</h1>
        <div id="timer-section">â³ Thá»i gian: <span id="timer">00:00</span></div>
        <div id="instructions"><p>ğŸ’– ChÃ o má»«ng báº¡n! HÃ£y sáºµn sÃ ng chinh phá»¥c tiáº¿ng Trung nhÃ©!</p></div>
        <div id="game-area"></div>
        <div id="hint-section"><button id="hint-button">ğŸ’¡ Gá»£i Ã½ cho tÃ´i nÃ o!</button><p id="hint-text"></p></div>
        <div id="feedback-section"><p id="feedback-text"></p></div>
        <button id="next-button" class="hidden">Tiáº¿p tá»¥c ğŸ’ª</button>
    </div>
    <div id="tooltip" class="tooltip"><span id="tooltip-hanzi"></span><span id="tooltip-pinyin"></span><span id="tooltip-meaning"></span></div>
    <div id="summary-page"><h2>ğŸ‰ HoÃ n ThÃ nh! ğŸ‰</h2><p>TÃªn há»c viÃªn: <span id="summary-player-name"></span></p><p>Tá»•ng thá»i gian: <span id="summary-time"></span></p><p>Sá»‘ cÃ¢u Ä‘Ãºng: <span id="summary-correct"></span></p><p>Sá»‘ cÃ¢u sai: <span id="summary-incorrect"></span></p><h3>Chi tiáº¿t lá»—i sai:</h3><ul id="summary-errors"></ul><button id="submit-report-button" style="background-color: #28a745;">Ná»™p BÃ¡o CÃ¡o LÃªn Google Form ğŸ“‹</button><button id="restart-button">ChÆ¡i láº¡i tá»« Ä‘áº§u ğŸ”</button></div>

    <script>
        // ----- Dá»® LIá»†U TRÃ’ CHÆ I -----
        const vocabPart1 = [ { hanzi: 'å›¾ä¹¦åŸ', pinyin: 'TÃº shÅ« chÃ©ng' }, { hanzi: 'å¦å¤–', pinyin: 'LÃ¬ng wÃ i' }, { hanzi: 'å„ç§å„æ ·', pinyin: 'GÃ¨ zhÇ’ng gÃ¨ yÃ ng' }, { hanzi: 'å…´å¥‹', pinyin: 'XÄ«ng fÃ¨n' }, { hanzi: 'ä¹¦æ¶', pinyin: 'ShÅ« jiÃ ' }, { hanzi: 'æŠ½', pinyin: 'ChÅu' }, { hanzi: 'æŒ‘', pinyin: 'TiÄo' }, { hanzi: 'é™¤äº†â€¦â€¦ä»¥å¤–', pinyin: 'ChÃº leâ€¦â€¦yÇ wÃ i' }, { hanzi: 'ä¸ç»‡å“', pinyin: 'SÄ« zhÄ« pÇn' }, { hanzi: 'é’¥åŒ™é“¾', pinyin: 'YÃ o shi liÃ n' }, { hanzi: 'ç©å…·', pinyin: 'WÃ¡n jÃ¹' }, { hanzi: 'ç”µæ¢¯', pinyin: 'DiÃ n tÄ«' }, { hanzi: 'ç»´ä¿®', pinyin: 'WÃ©i xiÅ«' }, { hanzi: 'å¿½ç„¶', pinyin: 'HÅ« rÃ¡n' }, { hanzi: 'æ‹”', pinyin: 'BÃ¡' }, { hanzi: 'å“­ç¬‘ä¸å¾—', pinyin: 'KÅ« xiÃ o bÃ¹ dÃ©' } ];
        // Dá»¯ liá»‡u Pháº§n 2 Ä‘Ã£ Ä‘Æ°á»£c sá»­a lá»—i vá»‹ trÃ­ blank vÃ  sá»‘ lÆ°á»£ng
        const paragraphData = {
            text: "ä½ å¥½ã€‚æˆ‘å·²ç»åˆ°äº†<span class='new-word' data-key='tÃ ishÄn'>æ³°å±±</span>ï¼Œæˆ‘æ˜¯çˆ¬ä¸Š{blank1} çš„ï¼Œæ²¡æœ‰å<span class='new-word' data-key='lÇnchÄ“'>ç¼†è½¦</span>ã€‚<span class='new-word' data-key='dÄ“ng'>ç™»</span>ä¸Š<span class='new-word' data-key='tÃ ishÄn'>æ³°å±±</span>ï¼ŒçœŸæœ‰â€œ<span class='new-word' data-key='yÄ«lÇnzhÃ²ngshÄnxiÇo'>ä¸€è§ˆä¼—å±±å°</span>â€çš„æ„Ÿè§‰ã€‚æˆ‘è¿˜åœ¨å±±ä¸Šä½äº†ä¸€å¤œï¼Œç­‰ç¬¬äºŒå¤©æ—©ä¸Šçœ‹<span class='new-word' data-key='rÃ¬chÅ«'>æ—¥å‡º</span>ï¼Œèƒ½ç«™åœ¨<span class='new-word' data-key='tÃ ishÄn'>æ³°å±±</span>ä¸Šçœ‹<span class='new-word' data-key='rÃ¬chÅ«'>æ—¥å‡º</span>ï¼Œæˆ‘å¾ˆé«˜å…´ã€‚å½“æˆ‘ä»¬çœ‹åˆ°<span class='new-word' data-key='tÃ iyÃ¡ng'>å¤ªé˜³</span><span class='new-word' data-key='yÄ«xiÃ zi'>ä¸€ä¸‹å­</span><span class='new-word' data-key='tiÃ o'>è·³</span>{blank2} çš„æ—¶å€™ï¼Œéƒ½<span class='new-word' data-key='xÄ«ngfÃ¨n'>å…´å¥‹</span>åœ°å¤§å£°å«äº†èµ·æ¥ï¼ŒçœŸæ˜¯<span class='new-word' data-key='mÄ›i'>ç¾</span>{blank3} äº†ã€‚ä¸‹åˆï¼Œæˆ‘åˆä»<span class='new-word' data-key='tÃ ishÄn'>æ³°å±±</span>ä¸Šèµ°{blank4} äº†ã€‚æ˜å¤©æˆ‘è¦å»<span class='new-word' data-key='qÅ«fÃ¹'>æ›²é˜œ</span>å‚è§‚<span class='new-word' data-key='kÇ’ngmiÃ o'>å­”åº™</span>å’Œ<span class='new-word' data-key='kÇ’nglÃ­n'>å­”æ—</span>ã€‚åˆ°é‚£å„¿ä»¥åå†ç»™ä½ ä»‹ç»<span class='new-word' data-key='qÅ«fÃ¹'>æ›²é˜œ</span>çš„<span class='new-word' data-key='qÃ­ngkuÃ ng'>æƒ…å†µ</span>ã€‚è¿™æ¬¡æ¥æ—…è¡Œæˆ‘å¾ˆæ„‰å¿«ï¼Œ<span class='new-word' data-key='shÄndÅngdÃ xuÃ©'>å±±ä¸œå¤§å­¦</span>çš„æœ‹å‹å¾ˆ<span class='new-word' data-key='rÃ¨qÃ­ng'>çƒ­æƒ…</span>ï¼Œç»™äº†æˆ‘å¾ˆå¤šå¸®åŠ©ã€‚è¿™æ˜¯ç”¨æˆ‘æ‰‹æœºç…§çš„<span class='new-word' data-key='tÃ ishÄn'>æ³°å±±</span><span class='new-word' data-key='rÃ¬chÅ«'>æ—¥å‡º</span>ï¼Œå‘ç»™ä½ çœ‹çœ‹ã€‚",
            blanks: 4, // Chá»‰ cÃ³ 4 chá»— trá»‘ng
            newWords: { 'tÃ ishÄn': { pinyin: 'TÃ ishÄn', meaning: 'nÃºi ThÃ¡i SÆ¡n' }, 'lÇnchÄ“': { pinyin: 'lÇn chÄ“', meaning: 'cÃ¡p treo' }, 'dÄ“ng': { pinyin: 'dÄ“ng', meaning: 'leo, trÃ¨o' }, 'yÄ«lÇnzhÃ²ngshÄnxiÇo': { pinyin: 'yÄ« lÇn zhÃ²ng shÄn xiÇo', meaning: 'nÃºi non bá»‘n cÃµi trÃ´ng vá»i bÃ© con...' }, 'rÃ¬chÅ«': { pinyin: 'rÃ¬ chÅ«', meaning: 'máº·t trá»i má»c' }, 'tÃ iyÃ¡ng': { pinyin: 'tÃ i yÃ¡ng', meaning: 'máº·t trá»i' }, 'yÄ«xiÃ zi': { pinyin: 'yÄ« xiÃ  zi', meaning: 'Ä‘á»™t ngá»™t, vÃ¨o má»™t cÃ¡i' }, 'tiÃ o': { pinyin: 'tiÃ o', meaning: 'nháº£y' }, 'mÄ›i': { pinyin: 'mÄ›i', meaning: 'Ä‘áº¹p' }, 'qÅ«fÃ¹': { pinyin: 'QÅ« fÃ¹', meaning: 'ThÃ nh phá»‘ KhÃºc Phá»¥' }, 'kÇ’ngmiÃ o': { pinyin: 'KÇ’ng MiÃ o', meaning: 'miáº¿u thá» Khá»•ng Tá»­' }, 'kÇ’nglÃ­n': { pinyin: 'KÇ’ng LÃ­n', meaning: 'Khá»•ng LÃ¢m (nghÄ©a trang)' }, 'qÃ­ngkuÃ ng': { pinyin: 'qÃ­ng kuÃ ng', meaning: 'tÃ¬nh hÃ¬nh' }, 'shÄndÅngdÃ xuÃ©': { pinyin: 'ShÄn dÅng DÃ  xuÃ©', meaning: 'Äáº¡i há»c SÆ¡n ÄÃ´ng' }, 'rÃ¨qÃ­ng': { pinyin: 'rÃ¨ qÃ­ng', meaning: 'nhiá»‡t tÃ¬nh' }, 'xÄ«ngfÃ¨n': { pinyin: 'XÄ«ng fÃ¨n', meaning: 'pháº¥n khÃ­ch' } },
            hints: [ // Gá»£i Ã½ cho 4 chá»— trá»‘ng
                 "çˆ¬ä¸Š (_____) çš„: ThÆ°á»ng Ä‘iá»n bá»• ngá»¯ káº¿t quáº£/xu hÆ°á»›ng sau 'çˆ¬'.",
                 "è·³ (_____) çš„æ—¶å€™: Tá»« chá»‰ káº¿t quáº£/xu hÆ°á»›ng cá»§a hÃ nh Ä‘á»™ng 'è·³'.",
                 "ç¾ (_____) äº†: Tá»« chá»‰ má»©c Ä‘á»™ cao, thÆ°á»ng lÃ  'cá»±c ká»³', 'vÃ´ cÃ¹ng'.",
                 "èµ° (_____) äº†: Tá»« chá»‰ phÆ°Æ¡ng hÆ°á»›ng/káº¿t quáº£ cá»§a viá»‡c 'èµ°' tá»« trÃªn nÃºi.",
             ]
         };
        const hintsPart1 = [ "HÃ£y thá»­ dÃ¹ng tá»« 'å›¾ä¹¦åŸ' Ä‘á»ƒ nÃ³i vá» nÆ¡i cÃ³ nhiá»u sÃ¡ch.", "DÃ¹ng 'å„ç§å„æ ·' Ä‘á»ƒ miÃªu táº£ sá»± Ä‘a dáº¡ng.", "NghÄ© xem 'é™¤äº†â€¦â€¦ä»¥å¤–' cÃ³ thá»ƒ dÃ¹ng trong cáº¥u trÃºc nÃ o?", "Báº¡n cáº£m tháº¥y tháº¿ nÃ o khi tháº¥y nhiá»u thá»© hay? (Gá»£i Ã½: å…´å¥‹)", "LÃ m sao Ä‘á»ƒ diá»…n táº£ viá»‡c khÃ´ng biáº¿t nÃªn cÆ°á»i hay nÃªn khÃ³c?" ];

        // ----- BIáº¾N TRáº NG THÃI GAME -----
        let currentPart = 0; let startTime; let timerInterval;
        let gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00' };
        let currentHintIndex = 0; let currentVocabIndexPart1 = 0; let currentTargetWordPart1 = null;
        let playerName = "";

        // ----- GOOGLE FORM CONFIGURATION (ÄÃ£ Ä‘Æ°á»£c cáº­p nháº­t tá»« input cá»§a báº¡n) -----
        const GOOGLE_FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeBAu4nmQQX6F3wMeoEzwgCH-JFKT8e1wJ3u-yp4KANey39Fw/formResponse"; // <-- OK
        const STUDENT_NAME_ENTRY_ID = "entry.497915687";    // <-- OK (Cáº§n báº¡n xÃ¡c nháº­n láº¡i láº§n ná»¯a náº¿u váº«n lá»—i 400)
        const TOTAL_TIME_ENTRY_ID = "entry.1644850563";      // <-- OK (Cáº§n báº¡n xÃ¡c nháº­n láº¡i láº§n ná»¯a náº¿u váº«n lá»—i 400)
        const CORRECT_COUNT_ENTRY_ID = "entry.1575464331";   // <-- OK (Cáº§n báº¡n xÃ¡c nháº­n láº¡i láº§n ná»¯a náº¿u váº«n lá»—i 400)
        const INCORRECT_COUNT_ENTRY_ID = "entry.1038973429"; // <-- OK (Cáº§n báº¡n xÃ¡c nháº­n láº¡i láº§n ná»¯a náº¿u váº«n lá»—i 400)
        const ERRORS_LIST_ENTRY_ID = "entry.888446367";      // <-- OK (Cáº§n báº¡n xÃ¡c nháº­n láº¡i láº§n ná»¯a náº¿u váº«n lá»—i 400)
        // ---------------------------------------------------------------------

        // ----- DOM ELEMENTS -----
        const getEl = (id) => document.getElementById(id);
        const timerEl = () => getEl('timer'); const instructionsEl = () => getEl('instructions'); const gameAreaEl = () => getEl('game-area'); const hintButtonEl = () => getEl('hint-button'); const hintTextEl = () => getEl('hint-text'); const feedbackSectionEl = () => getEl('feedback-section'); const feedbackTextEl = () => getEl('feedback-text'); const nextButtonEl = () => getEl('next-button'); const summaryPageEl = () => getEl('summary-page'); const gameContainerEl = () => getEl('game-container'); const tooltipEl = () => getEl('tooltip');

        // ----- FUNCTIONS -----

        // --- AI Integration (Google Gemini Flash) ---
        async function callAI(prompt) {
            const currentFeedbackEl = feedbackTextEl(); const currentFeedbackSectionEl = feedbackSectionEl();
            console.log(`--- Gá»i AI (Gemini Flash) vá»›i prompt (${currentPart === 1 ? 'Check Sentence' : (currentPart === 2 ? (prompt.includes("táº¡o má»™t gá»£i Ã½") ? 'Generate Hint' : 'Check Paragraph') : 'Unknown')}) ---`);
            console.log(prompt);
             if (!currentFeedbackEl || !currentFeedbackSectionEl) { console.error("Feedback elements not found!"); return { isCorrect: false, explanation: "Lá»—i giao diá»‡n: KhÃ´ng tÃ¬m tháº¥y vÃ¹ng hiá»ƒn thá»‹ pháº£n há»“i." }; }
             if (!prompt.includes("táº¡o má»™t gá»£i Ã½ NGáº®N Gá»ŒN")) { currentFeedbackEl.textContent = "ğŸ§  Gemini Flash AI Ä‘ang suy nghÄ©..."; currentFeedbackSectionEl.className = 'info'; currentFeedbackSectionEl.style.display = 'block'; }

            // !! Cáº¢NH BÃO Báº¢O Máº¬T !!
            const apiKey = 'AIzaSyBvdzFJAA8xSTMZ17nse19boON9zGopUyU';
            // !! Káº¾T THÃšC Cáº¢NH BÃO Báº¢O Máº¬T !!

            const modelName = 'gemini-1.5-flash-latest';
            const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const generationConfig = { temperature: 0.5, maxOutputTokens: 300, };
            const safetySettings = [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, ];

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ contents: [{ parts: [{ "text": prompt }] }], generationConfig: generationConfig, safetySettings: safetySettings }),
                });
                if (!response.ok) { let errorData; try { errorData = await response.json(); console.error("Lá»—i API (JSON):", errorData); } catch (e) { const errorText = await response.text(); console.error("Lá»—i API (Text):", errorText); errorData = { error: { message: errorText || 'KhÃ´ng Ä‘á»c Ä‘Æ°á»£c lá»—i' } }; } const errorMessage = `Lá»—i API ${response.status}: ${errorData?.error?.message || response.statusText || 'KhÃ´ng rÃµ chi tiáº¿t'}. Vui lÃ²ng kiá»ƒm tra láº¡i API Key vÃ  káº¿t ná»‘i máº¡ng.`; throw new Error(errorMessage); }
                const data = await response.json();
                console.log(`Pháº£n há»“i tá»« ${modelName}:`, data);
                 if (!data.candidates || data.candidates.length === 0) { const blockReason = data?.promptFeedback?.blockReason; const safetyRatings = data?.promptFeedback?.safetyRatings; console.error("AI Response Blocked/Empty:", blockReason, safetyRatings); throw new Error(`Pháº£n há»“i tá»« AI bá»‹ cháº·n hoáº·c trá»‘ng. LÃ½ do: ${blockReason || 'KhÃ´ng rÃµ'}. HÃ£y thá»­ thay Ä‘á»•i prompt hoáº·c kiá»ƒm tra cÃ i Ä‘áº·t an toÃ n.`); }
                 const aiTextResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || "AI khÃ´ng Ä‘Æ°a ra pháº£n há»“i vÄƒn báº£n.";
                 console.log("Ná»™i dung AI tráº£ vá»:", aiTextResponse);

                  if (prompt.includes("táº¡o má»™t gá»£i Ã½ NGáº®N Gá»ŒN")) { return { explanation: aiTextResponse }; }
                  else {
                        let lowerResponse = aiTextResponse.toLowerCase(); let isCorrect = false;
                        if (currentPart === 1 && lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng")) { isCorrect = true; }
                        else if (currentPart === 2 && (lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng") || lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡ tá»•ng thá»ƒ: Ä‘Ãºng"))) { isCorrect = true; }
                        let explanation = aiTextResponse;
                        if (isCorrect && explanation.length > 100) { explanation = explanation.split('.')[0] + '.'; if (!explanation.toLowerCase().startsWith("Ä‘Ã¡nh giÃ¡")) { explanation = (currentPart === 1 ? "ÄÃ¡nh giÃ¡: ÄÃºng. CÃ¢u sá»­ dá»¥ng tá»‘t." : "ÄÃ¡nh giÃ¡: ÄÃºng. Táº¥t cáº£ Ä‘á»u phÃ¹ há»£p."); } }
                        return { isCorrect, explanation };
                  }
            } catch (error) {
                console.error(`Lá»—i khi gá»i ${modelName} API:`, error);
                if (prompt.includes("táº¡o má»™t gá»£i Ã½ NGáº®N Gá»ŒN")) { hintTextEl().textContent = "Lá»—i: KhÃ´ng thá»ƒ táº¡o gá»£i Ã½ tá»« AI."; hintButtonEl().disabled = false; return { explanation: "Lá»—i táº¡o gá»£i Ã½." }; }
                else { currentFeedbackEl.textContent = error.message; currentFeedbackSectionEl.className = 'incorrect'; currentFeedbackSectionEl.style.display = 'block'; throw error; }
            }
        }

        // --- Timer Functions ---
        function startTimer() { startTime = Date.now(); if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000); updateTimer(); }
        function updateTimer() { const currentTimerEl = timerEl(); if (!currentTimerEl) { if (timerInterval) clearInterval(timerInterval); return; } const elapsedTime = Math.floor((Date.now() - startTime) / 1000); const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0'); const seconds = (elapsedTime % 60).toString().padStart(2, '0'); currentTimerEl.textContent = `${minutes}:${seconds}`; gameResults.totalTime = `${minutes}:${seconds}`; }
        function stopTimer() { if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

        // --- UI and Feedback ---
        function setInstructions(text) { const currentInstructionsEl = instructionsEl(); if (currentInstructionsEl) currentInstructionsEl.innerHTML = `<p>ğŸ’– ${text}</p>`; }
        function showFeedback(isCorrect, message) { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.textContent = message; currentFeedbackSectionEl.className = isCorrect ? 'correct' : 'incorrect'; currentFeedbackSectionEl.style.display = 'block'; }
        function recordResult(isCorrect, part, input, issue) { if (isCorrect) { gameResults.correct++; } else { gameResults.incorrect++; gameResults.errors.push({ part, input: input || 'N/A', issue }); } console.log("Game Results Updated:", JSON.stringify(gameResults)); }
        function clearFeedback() { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.textContent = ''; currentFeedbackSectionEl.style.display = 'none'; currentFeedbackSectionEl.className = ''; }
        // --- HÃ m showHint dÃ¹ng AI (ÄÃ£ cáº­p nháº­t á»Ÿ láº§n trÆ°á»›c) ---
        async function showHint() {
            const currentHintTextEl = hintTextEl(); const currentHintButtonEl = hintButtonEl();
             if (!currentHintTextEl || !currentHintButtonEl) return;
             currentHintButtonEl.disabled = true; currentHintTextEl.textContent = "ğŸ§  AI Ä‘ang táº¡o gá»£i Ã½...";
            let hint = "KhÃ´ng cÃ³ gá»£i Ã½ nÃ o cho pháº§n nÃ y.";
             try {
                 if (currentPart === 1 && currentTargetWordPart1) { hint = `HÃ£y thá»­ nghÄ© vá» cÃ¡ch dÃ¹ng tá»« "${currentTargetWordPart1.hanzi}" trong má»™t cÃ¢u hoÃ n chá»‰nh xem sao? NÃ³ cÃ³ nghÄ©a lÃ  '${currentTargetWordPart1.pinyin}'.`; currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
                 else if (currentPart === 2) {
                      const blanks = document.querySelectorAll('.blank-input'); let firstEmptyIndex = -1;
                      blanks.forEach((input, index) => { if (input.value.trim() === '' && firstEmptyIndex === -1) { firstEmptyIndex = index; } });
                      if (firstEmptyIndex !== -1) {
                           const blankNumber = firstEmptyIndex + 1; console.log(`Requesting hint for blank ${blankNumber}`);
                           let paragraphForHint = paragraphData.text; // DÃ¹ng text Ä‘Ã£ sá»­a lá»—i
                           paragraphForHint = paragraphForHint.replace(`{blank${blankNumber}}`, `[Gá»¢I_Ã_CHO_Ã”_NÃ€Y]`);
                           for (let i = 1; i <= paragraphData.blanks; i++) { if (i !== blankNumber) { const filledValue = getEl(`blank-${i}`)?.value.trim(); paragraphForHint = paragraphForHint.replace(`{blank${i}}`, filledValue ? `(${filledValue})` : `[BLANK_${i}]`); } }
                           paragraphForHint = paragraphForHint.replace(/<span[^>]*>/g, '').replace(/<\/span>/g, '');
                           const hintPrompt = `LÃ  má»™t trá»£ lÃ½ tiáº¿ng Trung, hÃ£y táº¡o má»™t gá»£i Ã½ NGáº®N Gá»ŒN (tá»‘i Ä‘a 15 tá»« tiáº¿ng Viá»‡t) cho ngÆ°á»i há»c Ä‘iá»n vÃ o chá»— trá»‘ng "[Gá»¢I_Ã_CHO_Ã”_NÃ€Y]" trong Ä‘oáº¡n vÄƒn sau. Gá»£i Ã½ cáº§n táº­p trung vÃ o nghÄ©a hoáº·c loáº¡i tá»« cáº§n Ä‘iá»n, khÃ´ng tiáº¿t lá»™ Ä‘Ã¡p Ã¡n.\nÄoáº¡n vÄƒn: "${paragraphForHint}"\nChá»‰ cung cáº¥p ná»™i dung gá»£i Ã½ báº±ng tiáº¿ng Viá»‡t.`;
                           const aiResult = await callAI(hintPrompt);
                           hint = aiResult.explanation || "KhÃ´ng thá»ƒ táº¡o gá»£i Ã½ lÃºc nÃ y.";
                           currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false;
                      } else { hint = "Báº¡n lÃ m tá»‘t láº¯m, khÃ´ng cáº§n gá»£i Ã½ ná»¯a Ä‘Ã¢u! ğŸ˜‰"; currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
                 } else { currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
             } catch (error) { console.error("Lá»—i khi táº¡o gá»£i Ã½:", error); hint = "ÄÃ£ xáº£y ra lá»—i khi láº¥y gá»£i Ã½ tá»« AI."; currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
        }
        function clearHint() { const currentHintTextEl = hintTextEl(); if (currentHintTextEl) currentHintTextEl.textContent = ''; }

        // --- Tooltip Logic ---
        function showTooltip(element, key) { const currentTooltipEl = tooltipEl(); if (!currentTooltipEl || !paragraphData || !paragraphData.newWords) return; const wordData = paragraphData.newWords[key]; if (!wordData) return; const hanziEl = currentTooltipEl.querySelector('#tooltip-hanzi'); const pinyinEl = currentTooltipEl.querySelector('#tooltip-pinyin'); const meaningEl = currentTooltipEl.querySelector('#tooltip-meaning'); if(hanziEl) hanziEl.textContent = element.textContent; if(pinyinEl) pinyinEl.textContent = `Pinyin: ${wordData.pinyin || 'N/A'}`; if(meaningEl) meaningEl.textContent = `NghÄ©a: ${wordData.meaning || 'N/A'}`; const rect = element.getBoundingClientRect(); let top = rect.bottom + window.scrollY + 5; let left = rect.left + window.scrollX; currentTooltipEl.style.display = 'block'; currentTooltipEl.style.left = `0px`; currentTooltipEl.style.top = `0px`; const tooltipRect = currentTooltipEl.getBoundingClientRect(); left = rect.left + window.scrollX + (rect.width / 2) - (tooltipRect.width / 2); top = rect.bottom + window.scrollY + 8; if (top + tooltipRect.height > window.innerHeight + window.scrollY) { top = rect.top + window.scrollY - tooltipRect.height - 8; } if (left + tooltipRect.width > window.innerWidth) { left = window.innerWidth - tooltipRect.width - 10; } if (left < 0) { left = 10; } if (top < window.scrollY) { top = window.scrollY + 10; } currentTooltipEl.style.left = `${left}px`; currentTooltipEl.style.top = `${top}px`; document.removeEventListener('click', hideTooltipOnClickOutside, true); document.addEventListener('click', hideTooltipOnClickOutside, true); }
        function hideTooltip() { const currentTooltipEl = tooltipEl(); if (currentTooltipEl) currentTooltipEl.style.display = 'none'; document.removeEventListener('click', hideTooltipOnClickOutside, true); }
        function hideTooltipOnClickOutside(event) { const currentTooltipEl = tooltipEl(); if (!currentTooltipEl || currentTooltipEl.contains(event.target) || event.target.classList.contains('new-word')) { return; } hideTooltip(); }

        // --- Game Part Logic ---
        function loadPart1() { currentPart = 1; setInstructions("Pháº§n 1: Äáº·t cÃ¢u. HÃ£y Ä‘áº·t má»™t cÃ¢u tiáº¿ng Trung tá»± nhiÃªn vÃ  logic sá»­ dá»¥ng tá»« dÆ°á»›i Ä‘Ã¢y nhÃ©! ğŸ˜Š"); clearFeedback(); clearHint(); currentVocabIndexPart1 = 0; currentTargetWordPart1 = null; const currentNextButtonEl = nextButtonEl(); const currentHintButtonEl = hintButtonEl(); const currentgameAreaEl = gameAreaEl(); if(currentgameAreaEl) { currentgameAreaEl.innerHTML = ` <div id="current-word-area" style="margin-bottom: 20px; padding: 15px; background-color: #fffacd; border-radius: 8px; text-align: center;"> <p><strong>HÃ£y Ä‘áº·t cÃ¢u vá»›i tá»«:</strong></p> <span id="current-word-hanzi" style="font-size: 1.8em; font-weight: bold; display: block; margin-bottom: 5px;"></span> <span id="current-word-pinyin" style="font-size: 1.1em; color: grey; display: block;"></span> </div> <textarea id="sentence-input" rows="4" placeholder="Viáº¿t cÃ¢u cá»§a báº¡n vÃ o Ä‘Ã¢y..."></textarea> <button id="submit-sentence">Kiá»ƒm tra cÃ¢u ğŸ¤”</button> `; displayCurrentVocabWord(); const submitSentenceBtn = getEl('submit-sentence'); if (submitSentenceBtn) { submitSentenceBtn.addEventListener('click', handleSubmitSentence); } else { console.error("Submit sentence button not found after creation."); } } else { console.error("Game area element not found!"); return; } if (currentNextButtonEl) currentNextButtonEl.classList.add('hidden'); if (currentHintButtonEl) currentHintButtonEl.classList.remove('hidden'); }
        function displayCurrentVocabWord() { const currentgameAreaEl = gameAreaEl(); if (!currentgameAreaEl) return; if (vocabPart1 && currentVocabIndexPart1 < vocabPart1.length) { currentTargetWordPart1 = vocabPart1[currentVocabIndexPart1]; const hanziEl = getEl('current-word-hanzi'); const pinyinEl = getEl('current-word-pinyin'); const sentenceInputEl = getEl('sentence-input'); const submitButton = getEl('submit-sentence'); if (hanziEl && pinyinEl && currentTargetWordPart1) { hanziEl.textContent = currentTargetWordPart1.hanzi; pinyinEl.textContent = `(${currentTargetWordPart1.pinyin})`; } else { console.error("KhÃ´ng tÃ¬m tháº¥y element Ä‘á»ƒ hiá»ƒn thá»‹ tá»« hoáº·c tá»« khÃ´ng há»£p lá»‡."); return; } if(sentenceInputEl) sentenceInputEl.value = ''; if(submitButton) { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra cÃ¢u ğŸ¤”"; submitButton.classList.remove('hidden'); } clearFeedback(); clearHint(); nextButtonEl()?.classList.add('hidden'); } else { console.log("ÄÃ£ hoÃ n thÃ nh Pháº§n 1. Chuyá»ƒn sang Pháº§n 2."); loadPart2(); } }
        async function handleSubmitSentence() { const sentenceInput = getEl('sentence-input'); const sentence = sentenceInput ? sentenceInput.value.trim() : ''; if (!currentTargetWordPart1) { console.error("KhÃ´ng cÃ³ tá»« má»¥c tiÃªu hiá»‡n táº¡i Ä‘á»ƒ kiá»ƒm tra cÃ¢u."); showFeedback(false, "Lá»—i: KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c tá»« cáº§n Ä‘áº·t cÃ¢u."); return; } if (!sentence) { showFeedback(false, "Báº¡n chÆ°a nháº­p cÃ¢u nÃ o cáº£! Vui lÃ²ng thá»­ láº¡i."); return; } const submitButton = getEl('submit-sentence'); const currentNextButtonEl = nextButtonEl(); if (!submitButton) { console.error("Submit button not found."); return; } submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang cháº¥m Ä‘iá»ƒm..."; clearFeedback(); const targetWordInfo = `${currentTargetWordPart1.hanzi} (${currentTargetWordPart1.pinyin})`; const prompt = `LÃ  má»™t giÃ¡o viÃªn tiáº¿ng Trung, hÃ£y Ä‘Ã¡nh giÃ¡ cÃ¢u sau: "${sentence}". CÃ¢u nÃ y cáº§n sá»­ dá»¥ng tá»« "${targetWordInfo}". YÃªu cáº§u: 1. ÄÃ¡nh giÃ¡ cÃ¢u lÃ  ÄÃºng hay Sai (vá» ngá»¯ phÃ¡p, logic vÃ  cÃ¡ch dÃ¹ng tá»« "${currentTargetWordPart1.hanzi}"). 2. Náº¿u Sai: Chá»‰ ra NGáº®N Gá»ŒN lá»—i sai chÃ­nh vÃ  Ä‘Æ°a ra 1 gá»£i Ã½ cáº£i thiá»‡n cÃ¢u. 3. Náº¿u ÄÃºng: Chá»‰ cáº§n ghi "ÄÃ¡nh giÃ¡: ÄÃºng. CÃ¢u sá»­ dá»¥ng tá»‘t.". HÃ£y tráº£ lá»i tháº­t ngáº¯n gá»n, táº­p trung vÃ o Ä‘iá»ƒm chÃ­nh.`; let isCorrect = false; let explanation = "CÃ³ lá»—i xáº£y ra khi kiá»ƒm tra."; try { const aiResult = await callAI(prompt); isCorrect = aiResult.isCorrect; explanation = aiResult.explanation; showFeedback(isCorrect, explanation); recordResult(isCorrect, 1, `Tá»«: ${targetWordInfo} - CÃ¢u: ${sentence}`, isCorrect ? '' : explanation); if (isCorrect) { currentVocabIndexPart1++; setTimeout(displayCurrentVocabWord, 1500); } else { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i ğŸ¤”"; } } catch (error) { if (!feedbackSectionEl()?.textContent) { showFeedback(false, `Lá»—i khi kiá»ƒm tra: ${error.message}`); } submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i ğŸ¤”"; recordResult(false, 1, `Tá»«: ${targetWordInfo} - CÃ¢u: ${sentence}`, `Lá»—i API: ${error.message}`); } }
        function loadPart2() { currentPart = 2; setInstructions("Pháº§n 2: Äiá»n tá»« vÃ o chá»— trá»‘ng. HÃ£y Ä‘á»c ká»¹ Ä‘oáº¡n vÄƒn vÃ  Ä‘iá»n tá»« thÃ­ch há»£p nhÃ©. Click vÃ o <span class='new-word' data-key='placeholder' style='color:red; font-weight:bold;'>tá»« mÃ u Ä‘á»</span> Ä‘á»ƒ xem nghÄ©a! ğŸ˜‰"); clearFeedback(); clearHint(); currentHintIndex = 0; const currentgameAreaEl = gameAreaEl(); const currentNextButtonEl = nextButtonEl(); const currentHintButtonEl = hintButtonEl(); if(!currentgameAreaEl || !paragraphData || !paragraphData.text) { console.error("Game area or paragraph data missing for Part 2."); return; }
            let paragraphHtml = paragraphData.text; // DÃ¹ng text Ä‘Ã£ sá»­a lá»—i
            if(paragraphData.blanks > 0){ for (let i = 1; i <= paragraphData.blanks; i++) { paragraphHtml = paragraphHtml.replace(`{blank${i}}`, `<input type="text" class="blank-input" id="blank-${i}" data-blank-id="${i}">`); } } else { console.warn("No blanks specified in paragraphData."); }
            currentgameAreaEl.innerHTML = ` <div class="paragraph-container">${paragraphHtml}</div> <button id="submit-paragraph">Kiá»ƒm tra bÃ i Ä‘iá»n tá»« âœ…</button> `;
            document.querySelectorAll('.new-word').forEach(wordEl => { const key = wordEl.getAttribute('data-key'); if (key && key !== 'placeholder') { wordEl.addEventListener('click', (event) => { showTooltip(event.target, key); event.stopPropagation(); }); } }); const submitParaBtn = getEl('submit-paragraph'); if(submitParaBtn) { submitParaBtn.addEventListener('click', handleSubmitParagraph); } else { console.error("Submit paragraph button not found after creation."); } if(currentNextButtonEl) currentNextButtonEl.classList.add('hidden'); if(currentHintButtonEl) currentHintButtonEl.classList.remove('hidden');
        }
        async function handleSubmitParagraph() { const answers = []; let allFilled = true; const blankInputs = document.querySelectorAll('.blank-input'); if(blankInputs.length !== paragraphData.blanks) { console.warn(`Mismatch between expected blanks (${paragraphData.blanks}) and found inputs (${blankInputs.length}). Check HTML generation.`); } if(blankInputs.length === 0) { console.warn("No blank input fields found to check."); return; } blankInputs.forEach((inputEl) => { const answer = inputEl.value.trim(); answers.push(answer); if (!answer) { allFilled = false; inputEl.style.borderBottomColor = 'red'; } else { inputEl.style.borderBottomColor = '#4682b4'; } }); if (!allFilled) { showFeedback(false, "Báº¡n Æ¡i, cÃ²n chá»— trá»‘ng chÆ°a Ä‘iá»n kÃ¬a! ğŸ˜®"); return; } const submitButton = getEl('submit-paragraph'); if (!submitButton) return; submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang cháº¥m Ä‘iá»ƒm..."; clearFeedback(); let paragraphForAI = paragraphData.text; try { if(paragraphData.blanks > 0) { for (let i = 1; i <= paragraphData.blanks; i++) { paragraphForAI = paragraphForAI.replace(new RegExp(`\\{blank${i}\\}`, 'g'), `[BLANK_${i}]`); } } paragraphForAI = paragraphForAI.replace(/<span[^>]*>/g, '').replace(/<\/span>/g, ''); } catch (error) { console.error("Error processing paragraph text for AI:", error); showFeedback(false, "Lá»—i xá»­ lÃ½ Ä‘oáº¡n vÄƒn."); submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i âœ…"; return; } const relevantNewWords = Object.entries(paragraphData.newWords || {}).filter(([key, data]) => paragraphData.text.includes(`data-key='${key}'`)).map(([key, data]) => `${data.hanzi} (${data.pinyin}): ${data.meaning}`).join('; '); const prompt = `ÄÃ¡nh giÃ¡ cÃ¡c tá»« há»c sinh Ä‘iá»n vÃ o Ä‘oáº¡n vÄƒn tiáº¿ng Trung sau. Äoáº¡n vÄƒn (chá»— trá»‘ng lÃ  [BLANK_X]): "${paragraphForAI}" Tá»« há»c sinh Ä‘iá»n (thá»© tá»± BLANK_1, 2,...): ${answers.join(' | ')} Chá»‰ tráº£ lá»i theo 1 trong 2 dáº¡ng sau ÄÃšNG HOÃ€N TOÃ€N: 1. Náº¿u Táº¤T Cáº¢ Ä‘á»u Ä‘Ãºng vÃ  phÃ¹ há»£p: Tráº£ lá»i duy nháº¥t "ÄÃ¡nh giÃ¡: ÄÃºng. Táº¥t cáº£ Ä‘á»u phÃ¹ há»£p." 2. Náº¿u cÃ³ Ã­t nháº¥t Má»˜T lá»—i: Tráº£ lá»i "ÄÃ¡nh giÃ¡: Sai." vÃ  ngay sau Ä‘Ã³ liá»‡t kÃª NGáº®N Gá»ŒN lá»—i á»Ÿ tá»«ng vá»‹ trÃ­ [BLANK_X] (vÃ­ dá»¥: "[BLANK_1]: Sai, nÃªn dÃ¹ng 'tá»« khÃ¡c'. [BLANK_3]: KhÃ´ng há»£p lÃ½."). KHÃ”NG giáº£i thÃ­ch dÃ i dÃ²ng hay phÃ¢n tÃ­ch cÃ¡c pháº§n Ä‘Ãºng náº¿u cÃ³ lá»—i.`; let isCorrect = false; let explanation = "CÃ³ lá»—i xáº£y ra khi kiá»ƒm tra."; const joinedAnswers = answers.join('; '); try { const aiResult = await callAI(prompt); isCorrect = aiResult.isCorrect; explanation = aiResult.explanation; showFeedback(isCorrect, explanation); recordResult(isCorrect, 2, joinedAnswers, isCorrect ? '' : explanation); if (isCorrect) { stopTimer(); showSummary(); submitButton.classList.add('hidden'); hintButtonEl()?.classList.add('hidden'); } else { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i âœ…"; } } catch (error) { if (!feedbackSectionEl()?.textContent) { showFeedback(false, `Lá»—i khi kiá»ƒm tra: ${error.message}`); } submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i âœ…"; recordResult(false, 2, joinedAnswers, `Lá»—i API: ${error.message}`); } }

         // --- HÃ m má»›i Ä‘á»ƒ gá»­i káº¿t quáº£ lÃªn Google Form ---
         function submitResultsToGoogleForm() { console.log("Preparing results for Google Form submission..."); if (GOOGLE_FORM_ACTION_URL === "https://docs.google.com/forms/d/e/YOUR_FORM_ID_HERE/formResponse" || !GOOGLE_FORM_ACTION_URL) { alert("Lá»—i cáº¥u hÃ¬nh: ChÆ°a Ä‘áº·t URL action cho Google Form trong mÃ£ JavaScript (GOOGLE_FORM_ACTION_URL)."); console.error("GOOGLE_FORM_ACTION_URL is not configured."); return; } if (STUDENT_NAME_ENTRY_ID === "entry.XXXXXXXXXX" /* Placeholder check */) { alert("Lá»—i cáº¥u hÃ¬nh: ChÆ°a Ä‘áº·t Ä‘á»§ cÃ¡c Entry ID cho Google Form trong mÃ£ JavaScript."); console.error("Google Form Entry IDs are not configured."); return; } const nameValue = playerName || "áº¨n danh"; const timeValue = gameResults.totalTime || "N/A"; const correctValue = gameResults.correct !== undefined ? gameResults.correct : "N/A"; const incorrectValue = gameResults.incorrect !== undefined ? gameResults.incorrect : "N/A"; const errorsString = (gameResults.errors && gameResults.errors.length > 0) ? gameResults.errors.map((err, index) => `${index + 1}. Pháº§n ${err.part}: ${err.issue}\n   (Input: ${err.input || 'N/A'})`).join('\n\n') : "KhÃ´ng cÃ³ lá»—i sai."; const formData = new URLSearchParams(); formData.append(STUDENT_NAME_ENTRY_ID, nameValue); formData.append(TOTAL_TIME_ENTRY_ID, timeValue); formData.append(CORRECT_COUNT_ENTRY_ID, correctValue.toString()); formData.append(INCORRECT_COUNT_ENTRY_ID, incorrectValue.toString()); formData.append(ERRORS_LIST_ENTRY_ID, errorsString); const finalUrl = `${GOOGLE_FORM_ACTION_URL}?${formData.toString()}`; console.log("Submitting to Google Form URL:", finalUrl); console.log("Data:", { name: nameValue, time: timeValue, correct: correctValue, incorrect: incorrectValue, errors: errorsString }); try { const formWindow = window.open(finalUrl, '_blank'); if (!formWindow || formWindow.closed || typeof formWindow.closed == 'undefined') { alert("TrÃ¬nh duyá»‡t cÃ³ thá»ƒ Ä‘Ã£ cháº·n cá»­a sá»• má»›i. Vui lÃ²ng cho phÃ©p popup vÃ  thá»­ láº¡i, hoáº·c sao chÃ©p link sau vÃ  má»Ÿ thá»§ cÃ´ng:\n\n" + finalUrl); } else { alert("ÄÃ£ má»Ÿ tab Google Form vá»›i káº¿t quáº£ cá»§a báº¡n. Vui lÃ²ng kiá»ƒm tra vÃ  nháº¥n 'Gá»­i' (Submit) trÃªn trang Ä‘Ã³ nhÃ©!"); } } catch (e) { console.error("Error opening Google Form:", e); alert("KhÃ´ng thá»ƒ tá»± Ä‘á»™ng má»Ÿ Google Form. Vui lÃ²ng sao chÃ©p link sau vÃ  má»Ÿ thá»§ cÃ´ng:\n\n" + finalUrl); } const submitButton = getEl('submit-report-button'); if (submitButton) { submitButton.disabled = true; submitButton.textContent = "ÄÃ£ Má»Ÿ Form âœ…"; submitButton.style.backgroundColor = '#6c757d'; } }

        // --- Summary Page ---
        function showSummary() { const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl(); if (!currentgameContainerEl || !currentsummaryPageEl) return; currentgameContainerEl.classList.add('hidden'); currentsummaryPageEl.style.display = 'block'; currentsummaryPageEl.classList.remove('hidden'); const summaryPlayerNameEl = getEl('summary-player-name'); const summaryTimeEl = getEl('summary-time'); const summaryCorrectEl = getEl('summary-correct'); const summaryIncorrectEl = getEl('summary-incorrect'); const errorsListEl = getEl('summary-errors'); const restartButton = getEl('restart-button'); if(summaryPlayerNameEl) summaryPlayerNameEl.textContent = playerName || "áº¨n danh"; if(summaryTimeEl) summaryTimeEl.textContent = gameResults.totalTime || 'N/A'; if(summaryCorrectEl) summaryCorrectEl.textContent = gameResults.correct || 0; if(summaryIncorrectEl) summaryIncorrectEl.textContent = gameResults.incorrect || 0; if(errorsListEl) { errorsListEl.innerHTML = ''; if (gameResults.errors && gameResults.errors.length > 0) { gameResults.errors.forEach(err => { const li = document.createElement('li'); const shortInput = err.input && err.input.length > 100 ? err.input.substring(0, 97) + '...' : err.input; li.innerHTML = `<strong>Pháº§n ${err.part}:</strong> ${err.issue} <br><small>(Input: ${shortInput || 'N/A'})</small>`; errorsListEl.appendChild(li); }); } else { errorsListEl.innerHTML = '<li>ChÃºc má»«ng! Báº¡n khÃ´ng máº¯c lá»—i nÃ o cáº£! âœ¨</li>'; } } else { console.error("Error list element not found in summary page."); } const submitReportButton = getEl('submit-report-button'); if (submitReportButton) { submitReportButton.disabled = false; submitReportButton.textContent = "Ná»™p BÃ¡o CÃ¡o LÃªn Google Form ğŸ“‹"; submitReportButton.style.backgroundColor = '#28a745'; submitReportButton.onclick = submitResultsToGoogleForm; } else { console.error("Submit report button not found in summary page."); } if (restartButton && !restartButton.dataset.listenerAttached) { restartButton.addEventListener('click', initGame); restartButton.dataset.listenerAttached = 'true'; } else if (!restartButton) { console.error("Restart button not found in summary page."); } }

        // --- Initialization ---
        function initGame() { console.log("Initializing game with Gemini Flash AI + Google Form Integration (Corrected Blanks)..."); currentPart = 0; gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00' }; playerName = ""; if (timerInterval) clearInterval(timerInterval); timerInterval = null; const currentTimerEl = timerEl(); if(currentTimerEl) currentTimerEl.textContent = '00:00'; const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl(); const currentgameAreaEl = gameAreaEl(); const currentNextButtonEl = nextButtonEl(); const currentInstructionsEl = instructionsEl(); if(currentgameContainerEl) currentgameContainerEl.classList.remove('hidden'); if(currentsummaryPageEl) currentsummaryPageEl.style.display = 'none'; if(currentgameAreaEl) currentgameAreaEl.innerHTML = ''; clearFeedback(); clearHint(); if(currentNextButtonEl) currentNextButtonEl.classList.add('hidden'); hideTooltip(); if (currentInstructionsEl) currentInstructionsEl.innerHTML = '<p>ğŸ‘‹ ChÃ o báº¡n! Vui lÃ²ng nháº­p tÃªn Ä‘á»ƒ báº¯t Ä‘áº§u.</p>'; if (currentgameAreaEl) { currentgameAreaEl.innerHTML = ` <div id="player-info" style="margin-bottom: 15px; padding: 20px; background-color: #e0f7fa; border-radius: 8px;"> <label for="player-name" style="display: block; margin-bottom: 8px; font-weight: bold;">TÃªn cá»§a báº¡n:</label> <input type="text" id="player-name" placeholder="Nháº­p tÃªn cá»§a báº¡n..." required style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;"> <button id="start-game-button" style="padding: 10px 20px;">Báº¯t Ä‘áº§u chÆ¡i!</button> </div> `; const startButton = getEl('start-game-button'); const playerNameInput = getEl('player-name'); if (startButton && playerNameInput) { playerNameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); startButton.click(); } }); startButton.addEventListener('click', () => { const name = playerNameInput.value.trim(); if (!name) { alert("Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n!"); return; } playerName = name; console.log("Player Name:", playerName); loadPart1(); startTimer(); }); } else { console.error("KhÃ´ng tÃ¬m tháº¥y nÃºt báº¯t Ä‘áº§u hoáº·c Ã´ nháº­p tÃªn."); } } else { console.error("Game area element not found for player info."); } const currentHintButtonEl = hintButtonEl(); if (currentHintButtonEl && !currentHintButtonEl.dataset.listenerAttached) { currentHintButtonEl.addEventListener('click', showHint); currentHintButtonEl.dataset.listenerAttached = 'true'; } else if (currentHintButtonEl) { currentHintButtonEl.classList.remove('hidden'); currentHintButtonEl.disabled = false; } else { console.warn("Hint button not found during init."); } }

        // ----- START GAME -----
        document.addEventListener('DOMContentLoaded', initGame);

    </script>
</body>
</html>
