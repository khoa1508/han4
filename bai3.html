<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Tiáº¿ng Trung Má»›i ğŸ¼ (Gemini Flash + Google Form Auto)</title>
    <style>
        /* ----- CSS khÃ´ng Ä‘á»•i ----- */
        body { font-family: sans-serif; line-height: 1.6; background-color: #f0f8ff; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; margin: 0; }
        #game-container { background-color: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); max-width: 800px; width: 100%; text-align: center; box-sizing: border-box; }
        h1 { color: #ff6347; margin-top: 0; }
        #timer-section { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #4682b4; }
        #instructions p { background-color: #e0f7fa; border-left: 5px solid #00bcd4; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: left; }
        #game-area { margin-bottom: 20px; text-align: left; }
        #current-word-area { margin-bottom: 20px; padding: 15px; background-color: #fffacd; border-radius: 8px; text-align: center; }
        #current-word-hanzi { font-size: 1.8em; font-weight: bold; display: block; margin-bottom: 5px;}
        #current-word-pinyin { font-size: 1.1em; color: grey; display: block;}
        #current-word-meaning { font-size: 1em; color: #555; display: block; margin-top: 5px; font-style: italic;} /* Hiá»ƒn thá»‹ nghÄ©a */
        #sentence-input { box-sizing: border-box; width: 100%; padding: 15px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; min-height: 80px; margin-bottom: 15px; display: block; }
        .paragraph-container { font-size: 1.2em; line-height: 1.8; margin-bottom: 20px; background-color: #f8f8f8; padding: 20px; border-radius: 8px; border: 1px solid #eee; text-align: left; }
        .blank-input { width: auto; min-width: 50px; border: none; border-bottom: 2px solid #4682b4; padding: 2px 5px; font-size: 1em; text-align: center; margin: 0 3px; background-color: transparent; vertical-align: baseline; }
        .new-word { color: red; font-weight: bold; cursor: pointer; position: relative; }
        .tooltip { display: none; position: absolute; background-color: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; z-index: 10; white-space: normal; max-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: left; }
        .tooltip span { display: block; margin-bottom: 3px; }
        .tooltip span:last-child { margin-bottom: 0; }
        #hint-section { margin-bottom: 20px; }
        #hint-text { color: #6a5acd; font-style: italic; min-height: 20px; margin-top: 10px; }
        #feedback-section { margin-top: 15px; padding: 10px; border-radius: 5px; min-height: 30px; display: none; word-wrap: break-word; text-align: left; }
        #feedback-section.correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #feedback-section.incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #feedback-section.info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        button { background-color: #ff6347; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease, transform 0.1s ease; margin: 10px 5px 5px 5px; }
        button:hover { background-color: #e5533d; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #summary-page { background-color: #e6f7ff; padding: 30px; border-radius: 10px; margin-top: 20px; text-align: left; display: none; }
        #summary-page h2 { text-align: center; color: #1890ff; }
        #summary-errors { padding-left: 20px; }
        #summary-errors li { color: #d9534f; margin-bottom: 5px; list-style: disc; }
        #summary-errors small { color: #555; }
        #submit-reminder { font-size: 1.25em; font-weight: bold; color: #856404; background-color: #fff3cd; padding: 15px; border-left: 6px solid #ffeeba; border-radius: 5px; margin-top: 25px; margin-bottom: 25px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Ã”n táº­p tiáº¿ng Trung cÃ¹ng AI ğŸš€</h1>
        <div id="timer-section">â³ Thá»i gian: <span id="timer">00:00</span></div>
        <div id="instructions"><p>ğŸ’– ChÃ o má»«ng báº¡n! HÃ£y sáºµn sÃ ng chinh phá»¥c tiáº¿ng Trung nhÃ©!</p></div>
        <div id="game-area"></div>
        <div id="hint-section"><button id="hint-button">ğŸ’¡ Gá»£i Ã½ cho tÃ´i nÃ o!</button><p id="hint-text"></p></div>
        <div id="feedback-section"><p id="feedback-text"></p></div>
        <button id="next-button" class="hidden">Tiáº¿p tá»¥c ğŸ’ª</button>
    </div>
    <div id="tooltip" class="tooltip"><span id="tooltip-hanzi"></span><span id="tooltip-pinyin"></span><span id="tooltip-meaning"></span></div>
    <div id="summary-page">
        <h2>ğŸ‰ HoÃ n ThÃ nh! ğŸ‰</h2>
        <p>TÃªn há»c viÃªn: <span id="summary-player-name"></span></p>
        <p>Tá»•ng thá»i gian: <span id="summary-time"></span></p>
        <p>Sá»‘ cÃ¢u Ä‘Ãºng: <span id="summary-correct"></span></p>
        <p>Sá»‘ cÃ¢u sai: <span id="summary-incorrect"></span></p>
        <h3>Chi tiáº¿t lá»—i sai:</h3>
        <ul id="summary-errors"></ul>
        <p id="submit-reminder">CÃ¡c báº¡n nhá»› áº¥n ná»™p káº¿t quáº£ lÃªn Google Form nhÃ©</p>
        <button id="submit-report-button" style="background-color: #28a745;">Ná»™p BÃ¡o CÃ¡o LÃªn Google Form ğŸ“‹</button>
        <button id="restart-button">ChÆ¡i láº¡i tá»« Ä‘áº§u ğŸ”</button>
    </div>

    <script>
        // ----- Dá»® LIá»†U TRÃ’ CHÆ I Má»šI -----
        const vocabPart1 = [
            { hanzi: 'å¥³å£«', pinyin: 'nÇšshÃ¬', meaning: 'bÃ  (xÆ°ng hÃ´ lá»‹ch sá»±)' },
            { hanzi: 'æœåŠ¡å‘˜', pinyin: 'fÃºwÃ¹yuÃ¡n', meaning: 'nhÃ¢n viÃªn phá»¥c vá»¥' },
            { hanzi: 'é•¿', pinyin: 'zhÇng', meaning: 'lá»›n (lÃªn), phÃ¡t triá»ƒn' },
            { hanzi: 'æ ·(å­)', pinyin: 'yÃ ng (zi)', meaning: 'dÃ¡ng, dÃ¡ng váº», hÃ¬nh dÃ¡ng' },
            { hanzi: 'ä¸ªå­', pinyin: 'gÃ¨zi', meaning: 'vÃ³c ngÆ°á»i, vÃ³c dÃ¡ng, thÃ¢n hÃ¬nh' },
            { hanzi: 'å·¦å³', pinyin: 'zuÇ’yÃ²u', meaning: 'khoáº£ng, khoáº£ng chá»«ng, trÃªn dÆ°á»›i, xáº¥p xá»‰' },
            { hanzi: 'æˆ´', pinyin: 'dÃ i', meaning: 'Ä‘eo, Ä‘á»™i, mang (phá»¥ kiá»‡n)' },
            { hanzi: 'ç€', pinyin: 'zhe', meaning: 'Ä‘ang (biá»ƒu thá»‹ sá»± tiáº¿p diá»…n cá»§a Ä‘á»™ng tÃ¡c hoáº·c tráº¡ng thÃ¡i)' },
            { hanzi: 'ç©¿', pinyin: 'chuÄn', meaning: 'máº·c (quáº§n Ã¡o)' },
            { hanzi: 'è¥¿æœ', pinyin: 'xÄ«fÃº', meaning: 'Ã¢u phá»¥c, com-lÃª' },
            { hanzi: 'è£™å­', pinyin: 'qÃºnzi', meaning: 'vÃ¡y' },
            { hanzi: 'å¹²', pinyin: 'gÃ n', meaning: 'lÃ m' },
            { hanzi: 'ä¸»æŒäºº', pinyin: 'zhÇ”chÃ­rÃ©n', meaning: 'ngÆ°á»i dáº«n chÆ°Æ¡ng trÃ¬nh, MC' },
            { hanzi: 'ä¸»æŒ', pinyin: 'zhÇ”chÃ­', meaning: 'dáº«n chÆ°Æ¡ng trÃ¬nh' },
            { hanzi: 'å°ä¼™å­', pinyin: 'xiÇohuÇ’zi', meaning: 'chÃ ng trai' }, // CÅ©ng cÃ³ thá»ƒ lÃ  xiÇohuÇ’r
            { hanzi: 'æ‰›', pinyin: 'kÃ¡ng', meaning: 'vÃ¡c' },
            { hanzi: 'æ‘„åƒæœº', pinyin: 'shÃ¨xiÃ ngjÄ«', meaning: 'mÃ¡y quay phim' },
            { hanzi: 'ä¼šè®®å…', pinyin: 'huÃ¬yÃ¬tÄ«ng', meaning: 'phÃ²ng há»™i nghá»‹, sáº£nh' },
            { hanzi: 'éº¦å…‹é£', pinyin: 'mÃ ikÃ¨fÄ“ng', meaning: 'micro' },
            { hanzi: 'è®²è¯', pinyin: 'jiÇnghuÃ ', meaning: 'nÃ³i, nÃ³i chuyá»‡n, phÃ¡t biá»ƒu' },
            { hanzi: 'å©šç¤¼', pinyin: 'hÅ«nlÇ', meaning: 'Ä‘Ã¡m cÆ°á»›i, lá»… cÆ°á»›i, hÃ´n lá»…' },
            { hanzi: 'çƒ­é—¹', pinyin: 'rÃ¨nao', meaning: 'nÃ¡o nhiá»‡t, nhá»™n nhá»‹p' },
            { hanzi: 'æŒ‚', pinyin: 'guÃ ', meaning: 'treo' },
            { hanzi: 'ç¯ç¬¼', pinyin: 'dÄ“nglong', meaning: 'Ä‘Ã¨n lá»“ng' },
            { hanzi: 'å¢™', pinyin: 'qiÃ¡ng', meaning: 'tÆ°á»ng' },
            { hanzi: 'åŒ', pinyin: 'shuÄng', meaning: 'Ä‘Ã´i, hai' },
            { hanzi: 'å–œ', pinyin: 'xÇ', meaning: 'háº¡nh phÃºc, vui, má»«ng' },
            { hanzi: 'æ‘†', pinyin: 'bÇi', meaning: 'bÃ y, sáº¯p xáº¿p' },
            { hanzi: 'æ–°å¨˜', pinyin: 'xÄ«nniÃ¡ng', meaning: 'cÃ´ dÃ¢u' },
            { hanzi: 'æ£‰è¢„', pinyin: 'miÃ¡n\'Ço', meaning: 'Ã¡o bÃ´ng' },
            { hanzi: 'æ–°éƒ', pinyin: 'xÄ«nlÃ¡ng', meaning: 'chÃº rá»ƒ' },
            { hanzi: 'å¸…', pinyin: 'shuÃ i', meaning: 'Ä‘áº¹p trai, Ä‘iá»ƒn trai' },
            { hanzi: 'ç³»', pinyin: 'jÃ¬', meaning: 'tháº¯t, buá»™c' },
            { hanzi: 'é¢†å¸¦', pinyin: 'lÇngdÃ i', meaning: 'cÃ  váº¡t' },
            { hanzi: 'çƒ­æƒ…', pinyin: 'rÃ¨qÃ­ng', meaning: 'nhiá»‡t tÃ¬nh, niá»m ná»Ÿ' },
            { hanzi: 'å®¢äºº', pinyin: 'kÃ¨rÃ©n', meaning: 'khÃ¡ch, khÃ¡ch khá»©a' },
            { hanzi: 'å€’', pinyin: 'dÃ o', meaning: 'rÃ³t, Ä‘á»•, dá»‘c' },
            { hanzi: 'åœ', pinyin: 'tÃ­ng', meaning: 'dá»«ng, ngá»«ng' },
            { hanzi: 'æ°”æ°›', pinyin: 'qÃ¬fÄ“n', meaning: 'khÃ´ng khÃ­' }
        ];

        const paragraphData = {
            text: "ç‹è€å¸ˆå·²ç»å¥½å‡ å¤©æ²¡æœ‰ â‘ {blank1} æˆ‘ä»¬ä¸Šè¯¾äº†ï¼Œå› ä¸ºä»–ç”Ÿç—…ä½é™¢äº†ã€‚è€å¸ˆä½é™¢ä»¥åï¼Œæˆ‘ä»¬ç­çš„å­¦ç”Ÿéƒ½å»åŒ»é™¢çœ‹ â‘¡{blank2} ä»–ã€‚æˆ‘ä»¬éƒ½å¸Œæœ›è€å¸ˆèƒ½æ—©ç‚¹å„¿å¥½ï¼Œå› ä¸ºæˆ‘ä»¬è§‰å¾—ä»–æ˜¯ä¸ªå¥½è€å¸ˆï¼Œå¯¹æˆ‘ä»¬å°±è±¡å¯¹è‡ªå·±çš„å„¿å¥³ä¸€æ ·ã€‚ ä»Šå¤©æ—©ä¸Šï¼Œæˆ‘ â‘¢{blank3} èµ°è¿›æ•™å®¤ï¼Œå°±çœ‹è§ç‹è€å¸ˆåœ¨<span class='new-word' data-key='jiÇngtÃ¡i'>è®²å°</span>æ—è¾¹ç«™ â‘£{blank4}ã€‚æˆ‘é«˜å…´â‘¤{blank5} å‘è€å¸ˆé—®äº†ä¸€å£°å¥½ã€‚æˆ‘é—®ï¼šâ€œè€å¸ˆï¼Œæ‚¨ä»€ä¹ˆæ—¶å€™å‡ºé™¢çš„ï¼Ÿâ€ â€œæˆ‘å‰å¤©å‡ºçš„é™¢ã€‚å¬è¯´ä½ ä¹Ÿç—…äº†ï¼Œå¥½ â‘¥{blank6} å—ï¼Ÿâ€ â€œå¥½äº†ã€‚è€å¸ˆï¼Œæ‚¨è¦<span class='new-word' data-key='bÇozhÃ²ng'>ä¿é‡</span>èº«ä½“ï¼â€ â€œè°¢è°¢ä½ ï¼â€ è¿™æ—¶ï¼ŒåŒå­¦ä»¬éƒ½èµ°è¿›æ•™å®¤ â‘¦{blank7} äº†ï¼Œå¤§å®¶çœ‹åˆ°ç‹è€å¸ˆåˆèƒ½ç»™æˆ‘ä»¬ä¸Šè¯¾äº†ï¼Œéƒ½å¾ˆé«˜å…´ã€‚è€å¸ˆä¹Ÿé«˜å…´åœ°å’Œå¤§å®¶è¯´ â‘§{blank8}ï¼Œé—®æ¯ä¸ªåŒå­¦çš„æƒ…å†µã€‚æˆ‘ä»¬éƒ½çŸ¥é“ç‹è€å¸ˆåˆšå‡ºé™¢ï¼Œèº«ä½“è¿˜ä¸å¤ªå¥½ã€‚ ä¸Šè¯¾<span class='new-word' data-key='lÃ­ng'>é“ƒ</span>å“äº†ã€‚ å¤§å®¶ä¸€èµ·å¤§å£°åœ°è¯´ï¼šâ€œè€å¸ˆå¥½ï¼â€ç‹è€å¸ˆç¬‘ â‘¨{blank9} ç‚¹äº†ç‚¹å¤´ï¼Œä¹Ÿå¯¹æˆ‘ä»¬è¯´ï¼šâ€œåŒå­¦ä»¬å¥½ï¼â€ è€å¸ˆæ‹¿èµ·ä¹¦è¦å¼€å§‹è®²è¯¾äº†ã€‚å±±æœ¬æ¬äº†ä¸€æŠŠ<span class='new-word' data-key='yÇzi'>æ¤…å­</span>ï¼Œèµ°åˆ°è€å¸ˆé¢å‰ï¼Œè¯´ï¼šâ€œè€å¸ˆï¼Œä»Šå¤©è¯·æ‚¨å â‘©{blank10} è®²å§ã€‚â€ ç‹è€å¸ˆè¯´ï¼šâ€œè°¢è°¢ï¼Œæˆ‘ä¸ç´¯ï¼Œæˆ‘ä¸ä¹ æƒ¯åç€ä¸Šè¯¾ã€‚â€ç‹è€å¸ˆæ²¡æœ‰åã€‚ â€œè€å¸ˆï¼Œè¯·æ‚¨åä¸‹è®²å§ï¼â€è¿™æ—¶ï¼Œ<span class='new-word' data-key='bÄnzhÇng'>ç­é•¿</span>å¸¦ç€å…¨ç­åŒå­¦ä¸€èµ·å¤§å£°åœ°è¯´ã€‚ ç‹è€å¸ˆæœ‰ç‚¹å„¿<span class='new-word' data-key='jÄ«dÃ²ng'>æ¿€åŠ¨</span>åœ°çœ‹ç€æˆ‘ä»¬è¯´ï¼šâ€œè°¢è°¢å¤§å®¶ï¼è°¢è°¢åŒå­¦ä»¬ï¼â€",
            blanks: 10, // 10 chá»— trá»‘ng
            newWords: {
                'jiÇngtÃ¡i': { hanzi: 'è®²å°', pinyin: 'jiÇngtÃ¡i', meaning: 'bá»¥c giáº£ng' },
                'bÇozhÃ²ng': { hanzi: 'ä¿é‡', pinyin: 'bÇozhÃ²ng', meaning: 'báº£o trá»ng, giá»¯ gÃ¬n' },
                'lÃ­ng': { hanzi: 'é“ƒ', pinyin: 'lÃ­ng', meaning: 'chuÃ´ng' },
                'yÇzi': { hanzi: 'æ¤…å­', pinyin: 'yÇzi', meaning: 'gháº¿' },
                'bÄnzhÇng': { hanzi: 'ç­é•¿', pinyin: 'bÄnzhÇng', meaning: 'lá»›p trÆ°á»Ÿng' },
                'jÄ«dÃ²ng': { hanzi: 'æ¿€åŠ¨', pinyin: 'jÄ«dÃ²ng', meaning: 'xÃºc Ä‘á»™ng' }
            },
            hints: [ // Gá»£i Ã½ cho 10 chá»— trá»‘ng (báº¡n nÃªn xem xÃ©t vÃ  sá»­a láº¡i cho tháº­t chÃ­nh xÃ¡c)
                "Äá»™ng tá»«, 'cho/Ä‘áº¿n' chÃºng tÃ´i.", // â‘ 
                "Äá»™ng tá»«, 'thÄƒm/gáº·p' tháº§y áº¥y.",        // â‘¡
                "PhÃ³ tá»«, chá»‰ thá»i gian/hÃ nh Ä‘á»™ng xáº£y ra ngay khi.", // â‘¢
                "Trá»£ tá»« Ä‘á»™ng thÃ¡i, biá»ƒu thá»‹ sá»± tiáº¿p diá»…n.", // â‘£
                "Tráº¡ng tá»«, chá»‰ má»©c Ä‘á»™ cá»§a hÃ nh Ä‘á»™ng 'há»i'.", // â‘¤
                "TÃ­nh tá»«, há»i thÄƒm sá»©c khá»e.", // â‘¥
                "Trá»£ tá»«, hoÃ n thÃ nh hÃ nh Ä‘á»™ng.", // â‘¦
                "Äá»™ng tá»«/Danh tá»«, liÃªn quan Ä‘áº¿n viá»‡c nÃ³i chuyá»‡n.", // â‘§
                "Trá»£ tá»« Ä‘á»™ng thÃ¡i, biá»ƒu thá»‹ cÃ¡ch thá»©c cá»§a hÃ nh Ä‘á»™ng 'cÆ°á»i'.", // â‘¨
                "Trá»£ tá»« Ä‘á»™ng thÃ¡i hoáº·c giá»›i tá»« chá»‰ vá»‹ trÃ­.", // â‘©
            ]
        };
        const hintsPart1Defaults = [ "HÃ£y thá»­ dÃ¹ng tá»« 'å¥³å£«' Ä‘á»ƒ nÃ³i vá» má»™t ngÆ°á»i phá»¥ ná»¯ má»™t cÃ¡ch lá»‹ch sá»±.", "DÃ¹ng 'çƒ­é—¹' Ä‘á»ƒ miÃªu táº£ má»™t khÃ´ng khÃ­ vui váº», nhá»™n nhá»‹p.", "NghÄ© xem 'é™¤äº†â€¦â€¦ä»¥å¤–' cÃ³ thá»ƒ dÃ¹ng trong cáº¥u trÃºc nÃ o?", "Báº¡n cáº£m tháº¥y tháº¿ nÃ o á»Ÿ má»™t 'å©šç¤¼' (Ä‘Ã¡m cÆ°á»›i)?", "LÃ m sao Ä‘á»ƒ diá»…n táº£ hÃ nh Ä‘á»™ng 'æ‰›' (vÃ¡c) má»™t váº­t náº·ng?" ]; // Gá»£i Ã½ máº·c Ä‘á»‹nh náº¿u AI lá»—i

        // ----- BIáº¾N TRáº NG THÃI GAME -----
        let currentPart = 0; let startTime; let timerInterval;
        let gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00' };
        let currentHintIndex = 0; let currentVocabIndexPart1 = 0; let currentTargetWordPart1 = null;
        let playerName = "";

        // ----- GOOGLE FORM CONFIGURATION (Sá»¬ Dá»¤NG Láº I THÃ”NG TIN CÅ¨, Náº¾U Cáº¦N FORM Má»šI, HÃƒY CUNG Cáº¤P Láº I) -----
        const GOOGLE_FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeBAu4nmQQX6F3wMeoEzwgCH-JFKT8e1wJ3u-yp4KANey39Fw/formResponse";
        const STUDENT_NAME_ENTRY_ID = "entry.497915687"; const TOTAL_TIME_ENTRY_ID = "entry.1644850563"; const CORRECT_COUNT_ENTRY_ID = "entry.1575464331"; const INCORRECT_COUNT_ENTRY_ID = "entry.1038973429"; const ERRORS_LIST_ENTRY_ID = "entry.888446367";

        // ----- DOM ELEMENTS -----
        const getEl = (id) => document.getElementById(id);
        const timerEl = () => getEl('timer'); const instructionsEl = () => getEl('instructions'); const gameAreaEl = () => getEl('game-area'); const hintButtonEl = () => getEl('hint-button'); const hintTextEl = () => getEl('hint-text'); const feedbackSectionEl = () => getEl('feedback-section'); const feedbackTextEl = () => getEl('feedback-text'); const nextButtonEl = () => getEl('next-button'); const summaryPageEl = () => getEl('summary-page'); const gameContainerEl = () => getEl('game-container'); const tooltipEl = () => getEl('tooltip');

        // ----- FUNCTIONS -----

        // --- AI Integration (Google Gemini Flash) ---
        async function callAI(prompt) {
            const currentFeedbackEl = feedbackTextEl(); const currentFeedbackSectionEl = feedbackSectionEl();
            let purpose = "Unknown";
            if (currentPart === 1) purpose = "Check Sentence";
            else if (currentPart === 2) purpose = prompt.includes("táº¡o má»™t gá»£i Ã½") ? 'Generate Hint' : 'Check Paragraph';

            console.log(`--- Gá»i AI (Gemini Flash) vá»›i prompt (${purpose}) ---`);
            console.log(prompt);

             if (!currentFeedbackEl || !currentFeedbackSectionEl) { console.error("Feedback elements not found!"); return { isCorrect: false, explanation: "Lá»—i giao diá»‡n: KhÃ´ng tÃ¬m tháº¥y vÃ¹ng hiá»ƒn thá»‹ pháº£n há»“i." }; }

             if (purpose !== 'Generate Hint') { // Chá»‰ hiá»‡n loading náº¿u khÃ´ng pháº£i Ä‘ang táº¡o gá»£i Ã½
                currentFeedbackEl.textContent = "ğŸ§  AI Ä‘ang suy nghÄ©...";
                currentFeedbackSectionEl.className = 'info';
                currentFeedbackSectionEl.style.display = 'block';
             }

            const apiKey = 'AIzaSyBvdzFJAA8xSTMZ17nse19boON9zGopUyU'; // Cáº£nh bÃ¡o báº£o máº­t váº«n Ã¡p dá»¥ng
            const modelName = 'gemini-1.5-flash-latest';
            const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const generationConfig = { temperature: 0.5, maxOutputTokens: 300, };
            const safetySettings = [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }, ]; // Ná»›i lá»ng safety settings

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ contents: [{ parts: [{ "text": prompt }] }], generationConfig: generationConfig, safetySettings: safetySettings }),
                });
                if (!response.ok) { let errorData; try { errorData = await response.json(); console.error("Lá»—i API (JSON):", errorData); } catch (e) { const errorText = await response.text(); console.error("Lá»—i API (Text):", errorText); errorData = { error: { message: errorText || 'KhÃ´ng Ä‘á»c Ä‘Æ°á»£c lá»—i' } }; } const errorMessage = `Lá»—i API ${response.status}: ${errorData?.error?.message || response.statusText || 'KhÃ´ng rÃµ chi tiáº¿t'}. Vui lÃ²ng kiá»ƒm tra láº¡i API Key vÃ  káº¿t ná»‘i máº¡ng.`; throw new Error(errorMessage); }
                const data = await response.json();
                console.log(`Pháº£n há»“i tá»« ${modelName}:`, data);

                 if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content || !data.candidates[0].content.parts || data.candidates[0].content.parts.length === 0) {
                     const blockReason = data?.promptFeedback?.blockReason || "KhÃ´ng cÃ³ á»©ng viÃªn tráº£ vá»";
                     const safetyRatings = data?.promptFeedback?.safetyRatings;
                     console.error("AI Response Blocked/Empty:", blockReason, safetyRatings);
                     throw new Error(`Pháº£n há»“i tá»« AI bá»‹ cháº·n hoáº·c trá»‘ng. LÃ½ do: ${blockReason}. HÃ£y thá»­ thay Ä‘á»•i prompt hoáº·c kiá»ƒm tra cÃ i Ä‘áº·t an toÃ n.`);
                 }

                 const aiTextResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || "AI khÃ´ng Ä‘Æ°a ra pháº£n há»“i vÄƒn báº£n.";
                 console.log("Ná»™i dung AI tráº£ vá»:", aiTextResponse);

                  if (purpose === 'Generate Hint') { return { explanation: aiTextResponse }; }
                  else {
                        let lowerResponse = aiTextResponse.toLowerCase(); let isCorrect = false;
                        if (currentPart === 1 && lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng")) { isCorrect = true; }
                        else if (currentPart === 2 && (lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng") || lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡ tá»•ng thá»ƒ: Ä‘Ãºng"))) { isCorrect = true; }
                        let explanation = aiTextResponse;
                        if (isCorrect && explanation.length > 100 && (explanation.includes("phÃ¢n tÃ­ch") || explanation.includes("giáº£i thÃ­ch"))) { // Cá»‘ gáº¯ng rÃºt gá»n hÆ¡n náº¿u váº«n dÃ i dÃ²ng
                             explanation = (currentPart === 1 ? "ÄÃ¡nh giÃ¡: ÄÃºng. CÃ¢u sá»­ dá»¥ng tá»‘t." : "ÄÃ¡nh giÃ¡: ÄÃºng. Táº¥t cáº£ Ä‘á»u phÃ¹ há»£p.");
                        } else if (isCorrect && explanation.length > 100) { // Náº¿u khÃ´ng cÃ³ tá»« khÃ³a phÃ¢n tÃ­ch nhÆ°ng váº«n dÃ i
                             explanation = explanation.split('.')[0] + '.';
                             if(!explanation.toLowerCase().startsWith("Ä‘Ã¡nh giÃ¡")) {
                                  explanation = (currentPart === 1 ? "ÄÃ¡nh giÃ¡: ÄÃºng. CÃ¢u sá»­ dá»¥ng tá»‘t." : "ÄÃ¡nh giÃ¡: ÄÃºng. Táº¥t cáº£ Ä‘á»u phÃ¹ há»£p.");
                             }
                        }
                        return { isCorrect, explanation };
                  }
            } catch (error) {
                console.error(`Lá»—i khi gá»i ${modelName} API:`, error);
                if (purpose === 'Generate Hint') { hintTextEl().textContent = "Lá»—i: KhÃ´ng thá»ƒ táº¡o gá»£i Ã½ tá»« AI."; hintButtonEl().disabled = false; return { explanation: "Lá»—i táº¡o gá»£i Ã½." }; }
                else { currentFeedbackEl.textContent = error.message; currentFeedbackSectionEl.className = 'incorrect'; currentFeedbackSectionEl.style.display = 'block'; throw error; }
            }
        }

        // --- Timer Functions ---
        function startTimer() { startTime = Date.now(); if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000); updateTimer(); }
        function updateTimer() { const currentTimerEl = timerEl(); if (!currentTimerEl) { if (timerInterval) clearInterval(timerInterval); return; } const elapsedTime = Math.floor((Date.now() - startTime) / 1000); const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0'); const seconds = (elapsedTime % 60).toString().padStart(2, '0'); currentTimerEl.textContent = `${minutes}:${seconds}`; gameResults.totalTime = `${minutes}:${seconds}`; }
        function stopTimer() { if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

        // --- UI and Feedback ---
        function setInstructions(text) { const currentInstructionsEl = instructionsEl(); if (currentInstructionsEl) currentInstructionsEl.innerHTML = `<p>ğŸ’– ${text}</p>`; }
        function showFeedback(isCorrect, message) { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.textContent = message; currentFeedbackSectionEl.className = isCorrect ? 'correct' : 'incorrect'; currentFeedbackSectionEl.style.display = 'block'; }
        function recordResult(isCorrect, part, input, issue) { if (isCorrect) { gameResults.correct++; } else { gameResults.incorrect++; gameResults.errors.push({ part, input: input || 'N/A', issue }); } console.log("Game Results Updated:", JSON.stringify(gameResults)); }
        function clearFeedback() { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.textContent = ''; currentFeedbackSectionEl.style.display = 'none'; currentFeedbackSectionEl.className = ''; }
        async function showHint() {
            const currentHintTextEl = hintTextEl(); const currentHintButtonEl = hintButtonEl();
             if (!currentHintTextEl || !currentHintButtonEl) return;
             currentHintButtonEl.disabled = true; currentHintTextEl.textContent = "ğŸ§  AI Ä‘ang táº¡o gá»£i Ã½...";
            let hint = "KhÃ´ng cÃ³ gá»£i Ã½ nÃ o cho pháº§n nÃ y.";
             try {
                 if (currentPart === 1 && currentTargetWordPart1) {
                    // Láº¥y gá»£i Ã½ máº·c Ä‘á»‹nh hoáº·c táº¡o tá»« AI náº¿u muá»‘n
                    const defaultHintsForWord1 = hintsPart1Defaults.filter(h => h.includes(currentTargetWordPart1.hanzi));
                    hint = defaultHintsForWord1.length > 0 ? defaultHintsForWord1[0] : `HÃ£y thá»­ Ä‘áº·t má»™t cÃ¢u hoÃ n chá»‰nh vá»›i tá»« "${currentTargetWordPart1.hanzi}" (${currentTargetWordPart1.pinyin}) cÃ³ nghÄ©a lÃ  "${currentTargetWordPart1.meaning}".`;
                    currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false;
                }
                 else if (currentPart === 2) {
                      const blanks = document.querySelectorAll('.blank-input'); let firstEmptyIndex = -1;
                      blanks.forEach((input, index) => { if (input.value.trim() === '' && firstEmptyIndex === -1) { firstEmptyIndex = index; } });
                      if (firstEmptyIndex !== -1) {
                           const blankNumber = firstEmptyIndex + 1; console.log(`Requesting hint for blank ${blankNumber}`);
                           let paragraphForHint = paragraphData.text;
                           paragraphForHint = paragraphForHint.replace(`{blank${blankNumber}}`, `[Gá»¢I_Ã_CHO_Ã”_NÃ€Y]`);
                           for (let i = 1; i <= paragraphData.blanks; i++) { if (i !== blankNumber) { const filledValue = getEl(`blank-${i}`)?.value.trim(); paragraphForHint = paragraphForHint.replace(`{blank${i}}`, filledValue ? `(${filledValue})` : `[BLANK_${i}]`); } }
                           paragraphForHint = paragraphForHint.replace(/<span[^>]*>/g, '').replace(/<\/span>/g, '');
                           const hintPrompt = `LÃ  má»™t trá»£ lÃ½ tiáº¿ng Trung, hÃ£y táº¡o má»™t gá»£i Ã½ NGáº®N Gá»ŒN (tá»‘i Ä‘a 15 tá»« tiáº¿ng Viá»‡t) cho ngÆ°á»i há»c Ä‘iá»n vÃ o chá»— trá»‘ng "[Gá»¢I_Ã_CHO_Ã”_NÃ€Y]" trong Ä‘oáº¡n vÄƒn sau. Gá»£i Ã½ cáº§n táº­p trung vÃ o nghÄ©a hoáº·c loáº¡i tá»« cáº§n Ä‘iá»n, khÃ´ng tiáº¿t lá»™ Ä‘Ã¡p Ã¡n.\nÄoáº¡n vÄƒn: "${paragraphForHint}"\nChá»‰ cung cáº¥p ná»™i dung gá»£i Ã½ báº±ng tiáº¿ng Viá»‡t.`;
                           const aiResult = await callAI(hintPrompt);
                           hint = aiResult.explanation || "KhÃ´ng thá»ƒ táº¡o gá»£i Ã½ lÃºc nÃ y.";
                           currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false;
                      } else { hint = "Báº¡n lÃ m tá»‘t láº¯m, khÃ´ng cáº§n gá»£i Ã½ ná»¯a Ä‘Ã¢u! ğŸ˜‰"; currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
                 } else { currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
             } catch (error) { console.error("Lá»—i khi táº¡o gá»£i Ã½:", error); hint = "ÄÃ£ xáº£y ra lá»—i khi láº¥y gá»£i Ã½ tá»« AI."; currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
        }
        function clearHint() { const currentHintTextEl = hintTextEl(); if (currentHintTextEl) currentHintTextEl.textContent = ''; }

        // --- Tooltip Logic ---
        function showTooltip(element, key) { const currentTooltipEl = tooltipEl(); if (!currentTooltipEl || !paragraphData || !paragraphData.newWords) return; const wordData = paragraphData.newWords[key]; if (!wordData) return; const hanziEl = currentTooltipEl.querySelector('#tooltip-hanzi'); const pinyinEl = currentTooltipEl.querySelector('#tooltip-pinyin'); const meaningEl = currentTooltipEl.querySelector('#tooltip-meaning'); if(hanziEl) hanziEl.textContent = element.textContent; if(pinyinEl) pinyinEl.textContent = `Pinyin: ${wordData.pinyin || 'N/A'}`; if(meaningEl) meaningEl.textContent = `NghÄ©a: ${wordData.meaning || 'N/A'}`; const rect = element.getBoundingClientRect(); let top = rect.bottom + window.scrollY + 5; let left = rect.left + window.scrollX; currentTooltipEl.style.display = 'block'; currentTooltipEl.style.left = `0px`; currentTooltipEl.style.top = `0px`; const tooltipRect = currentTooltipEl.getBoundingClientRect(); left = rect.left + window.scrollX + (rect.width / 2) - (tooltipRect.width / 2); top = rect.bottom + window.scrollY + 8; if (top + tooltipRect.height > window.innerHeight + window.scrollY) { top = rect.top + window.scrollY - tooltipRect.height - 8; } if (left + tooltipRect.width > window.innerWidth) { left = window.innerWidth - tooltipRect.width - 10; } if (left < 0) { left = 10; } if (top < window.scrollY) { top = window.scrollY + 10; } currentTooltipEl.style.left = `${left}px`; currentTooltipEl.style.top = `${top}px`; document.removeEventListener('click', hideTooltipOnClickOutside, true); document.addEventListener('click', hideTooltipOnClickOutside, true); }
        function hideTooltip() { const currentTooltipEl = tooltipEl(); if (currentTooltipEl) currentTooltipEl.style.display = 'none'; document.removeEventListener('click', hideTooltipOnClickOutside, true); }
        function hideTooltipOnClickOutside(event) { const currentTooltipEl = tooltipEl(); if (!currentTooltipEl || currentTooltipEl.contains(event.target) || event.target.classList.contains('new-word')) { return; } hideTooltip(); }

        // --- Game Part Logic ---
        function loadPart1() { currentPart = 1; setInstructions("Pháº§n 1: Äáº·t cÃ¢u. HÃ£y Ä‘áº·t má»™t cÃ¢u tiáº¿ng Trung tá»± nhiÃªn vÃ  logic sá»­ dá»¥ng tá»« dÆ°á»›i Ä‘Ã¢y nhÃ©! ğŸ˜Š"); clearFeedback(); clearHint(); currentVocabIndexPart1 = 0; currentTargetWordPart1 = null; const currentNextButtonEl = nextButtonEl(); const currentHintButtonEl = hintButtonEl(); const currentgameAreaEl = gameAreaEl(); if(currentgameAreaEl) { currentgameAreaEl.innerHTML = ` <div id="current-word-area" style="margin-bottom: 20px; padding: 15px; background-color: #fffacd; border-radius: 8px; text-align: center;"> <p><strong>HÃ£y Ä‘áº·t cÃ¢u vá»›i tá»«:</strong></p> <span id="current-word-hanzi" style="font-size: 1.8em; font-weight: bold; display: block; margin-bottom: 5px;"></span> <span id="current-word-pinyin" style="font-size: 1.1em; color: grey; display: block;"></span> <span id="current-word-meaning" style="font-size: 1em; color: #555; display: block; margin-top: 5px; font-style: italic;"></span> </div> <textarea id="sentence-input" rows="4" placeholder="Viáº¿t cÃ¢u cá»§a báº¡n vÃ o Ä‘Ã¢y..."></textarea> <button id="submit-sentence">Kiá»ƒm tra cÃ¢u ğŸ¤”</button> `; displayCurrentVocabWord(); const submitSentenceBtn = getEl('submit-sentence'); if (submitSentenceBtn) { submitSentenceBtn.addEventListener('click', handleSubmitSentence); } else { console.error("Submit sentence button not found after creation."); } } else { console.error("Game area element not found!"); return; } if (currentNextButtonEl) currentNextButtonEl.classList.add('hidden'); if (currentHintButtonEl) currentHintButtonEl.classList.remove('hidden'); }
        function displayCurrentVocabWord() { const currentgameAreaEl = gameAreaEl(); if (!currentgameAreaEl) return; if (vocabPart1 && currentVocabIndexPart1 < vocabPart1.length) { currentTargetWordPart1 = vocabPart1[currentVocabIndexPart1]; const hanziEl = getEl('current-word-hanzi'); const pinyinEl = getEl('current-word-pinyin'); const meaningEl = getEl('current-word-meaning'); const sentenceInputEl = getEl('sentence-input'); const submitButton = getEl('submit-sentence'); if (hanziEl && pinyinEl && meaningEl && currentTargetWordPart1) { hanziEl.textContent = currentTargetWordPart1.hanzi; pinyinEl.textContent = `(${currentTargetWordPart1.pinyin})`; meaningEl.textContent = currentTargetWordPart1.meaning; } else { console.error("KhÃ´ng tÃ¬m tháº¥y element Ä‘á»ƒ hiá»ƒn thá»‹ tá»« hoáº·c tá»« khÃ´ng há»£p lá»‡."); return; } if(sentenceInputEl) sentenceInputEl.value = ''; if(submitButton) { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra cÃ¢u ğŸ¤”"; submitButton.classList.remove('hidden'); } clearFeedback(); clearHint(); nextButtonEl()?.classList.add('hidden'); } else { console.log("ÄÃ£ hoÃ n thÃ nh Pháº§n 1. Chuyá»ƒn sang Pháº§n 2."); loadPart2(); } }
        async function handleSubmitSentence() { const sentenceInput = getEl('sentence-input'); const sentence = sentenceInput ? sentenceInput.value.trim() : ''; if (!currentTargetWordPart1) { console.error("KhÃ´ng cÃ³ tá»« má»¥c tiÃªu hiá»‡n táº¡i Ä‘á»ƒ kiá»ƒm tra cÃ¢u."); showFeedback(false, "Lá»—i: KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c tá»« cáº§n Ä‘áº·t cÃ¢u."); return; } if (!sentence) { showFeedback(false, "Báº¡n chÆ°a nháº­p cÃ¢u nÃ o cáº£! Vui lÃ²ng thá»­ láº¡i."); return; } const submitButton = getEl('submit-sentence'); const currentNextButtonEl = nextButtonEl(); if (!submitButton) { console.error("Submit button not found."); return; } submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang cháº¥m Ä‘iá»ƒm..."; clearFeedback(); const targetWordInfo = `${currentTargetWordPart1.hanzi} (${currentTargetWordPart1.pinyin}): ${currentTargetWordPart1.meaning}`; const prompt = `LÃ  má»™t giÃ¡o viÃªn tiáº¿ng Trung, hÃ£y Ä‘Ã¡nh giÃ¡ cÃ¢u sau: "${sentence}". CÃ¢u nÃ y nÃªn sá»­ dá»¥ng tá»« "${targetWordInfo}". YÃªu cáº§u: 1. ÄÃ¡nh giÃ¡ cÃ¢u lÃ  ÄÃºng hay Sai (vá» ngá»¯ phÃ¡p, logic vÃ  cÃ¡ch dÃ¹ng tá»« "${currentTargetWordPart1.hanzi}"). 2. Náº¿u Sai: Chá»‰ ra NGáº®N Gá»ŒN lá»—i sai chÃ­nh vÃ  Ä‘Æ°a ra 1 gá»£i Ã½ cáº£i thiá»‡n cÃ¢u. 3. Náº¿u ÄÃºng: Chá»‰ cáº§n ghi "ÄÃ¡nh giÃ¡: ÄÃºng. CÃ¢u sá»­ dá»¥ng tá»‘t.". HÃ£y tráº£ lá»i tháº­t ngáº¯n gá»n, táº­p trung vÃ o Ä‘iá»ƒm chÃ­nh.`; let isCorrect = false; let explanation = "CÃ³ lá»—i xáº£y ra khi kiá»ƒm tra."; try { const aiResult = await callAI(prompt); isCorrect = aiResult.isCorrect; explanation = aiResult.explanation; showFeedback(isCorrect, explanation); recordResult(isCorrect, 1, `Tá»«: ${targetWordInfo} - CÃ¢u: ${sentence}`, isCorrect ? '' : explanation); if (isCorrect) { currentVocabIndexPart1++; setTimeout(displayCurrentVocabWord, 1500); } else { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i ğŸ¤”"; } } catch (error) { if (!feedbackSectionEl()?.textContent) { showFeedback(false, `Lá»—i khi kiá»ƒm tra: ${error.message}`); } submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i ğŸ¤”"; recordResult(false, 1, `Tá»«: ${targetWordInfo} - CÃ¢u: ${sentence}`, `Lá»—i API: ${error.message}`); } }
        function loadPart2() { currentPart = 2; setInstructions("Pháº§n 2: Äiá»n tá»« vÃ o chá»— trá»‘ng. HÃ£y Ä‘á»c ká»¹ Ä‘oáº¡n vÄƒn vÃ  Ä‘iá»n tá»« thÃ­ch há»£p nhÃ©. Click vÃ o <span class='new-word' data-key='placeholder' style='color:red; font-weight:bold;'>tá»« mÃ u Ä‘á»</span> Ä‘á»ƒ xem nghÄ©a! ğŸ˜‰"); clearFeedback(); clearHint(); currentHintIndex = 0; const currentgameAreaEl = gameAreaEl(); const currentNextButtonEl = nextButtonEl(); const currentHintButtonEl = hintButtonEl(); if(!currentgameAreaEl || !paragraphData || !paragraphData.text) { console.error("Game area or paragraph data missing for Part 2."); return; } let paragraphHtml = paragraphData.text; if(paragraphData.blanks > 0){ for (let i = 1; i <= paragraphData.blanks; i++) { paragraphHtml = paragraphHtml.replace(`{blank${i}}`, `<input type="text" class="blank-input" id="blank-${i}" data-blank-id="${i}">`); } } else { console.warn("No blanks specified in paragraphData."); } currentgameAreaEl.innerHTML = ` <div class="paragraph-container">${paragraphHtml}</div> <button id="submit-paragraph">Kiá»ƒm tra bÃ i Ä‘iá»n tá»« âœ…</button> `; document.querySelectorAll('.new-word').forEach(wordEl => { const key = wordEl.getAttribute('data-key'); if (key && key !== 'placeholder') { wordEl.addEventListener('click', (event) => { showTooltip(event.target, key); event.stopPropagation(); }); } }); const submitParaBtn = getEl('submit-paragraph'); if(submitParaBtn) { submitParaBtn.addEventListener('click', handleSubmitParagraph); } else { console.error("Submit paragraph button not found after creation."); } if(currentNextButtonEl) currentNextButtonEl.classList.add('hidden'); if(currentHintButtonEl) currentHintButtonEl.classList.remove('hidden'); }
        async function handleSubmitParagraph() { const answers = []; let allFilled = true; const blankInputs = document.querySelectorAll('.blank-input'); if(blankInputs.length !== paragraphData.blanks) { console.warn(`Mismatch between expected blanks (${paragraphData.blanks}) and found inputs (${blankInputs.length}). Check HTML generation.`); } if(blankInputs.length === 0) { console.warn("No blank input fields found to check."); return; } blankInputs.forEach((inputEl) => { const answer = inputEl.value.trim(); answers.push(answer); if (!answer) { allFilled = false; inputEl.style.borderBottomColor = 'red'; } else { inputEl.style.borderBottomColor = '#4682b4'; } }); if (!allFilled) { showFeedback(false, "Báº¡n Æ¡i, cÃ²n chá»— trá»‘ng chÆ°a Ä‘iá»n kÃ¬a! ğŸ˜®"); return; } const submitButton = getEl('submit-paragraph'); if (!submitButton) return; submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang cháº¥m Ä‘iá»ƒm..."; clearFeedback(); let paragraphForAI = paragraphData.text; try { if(paragraphData.blanks > 0) { for (let i = 1; i <= paragraphData.blanks; i++) { paragraphForAI = paragraphForAI.replace(new RegExp(`\\{blank${i}\\}`, 'g'), `[BLANK_${i}]`); } } paragraphForAI = paragraphForAI.replace(/<span[^>]*>/g, '').replace(/<\/span>/g, ''); } catch (error) { console.error("Error processing paragraph text for AI:", error); showFeedback(false, "Lá»—i xá»­ lÃ½ Ä‘oáº¡n vÄƒn."); submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i âœ…"; return; } const relevantNewWords = Object.entries(paragraphData.newWords || {}).filter(([key, data]) => paragraphData.text.includes(`data-key='${key}'`)).map(([key, data]) => `${data.hanzi} (${data.pinyin}): ${data.meaning}`).join('; '); const prompt = `ÄÃ¡nh giÃ¡ cÃ¡c tá»« há»c sinh Ä‘iá»n vÃ o Ä‘oáº¡n vÄƒn tiáº¿ng Trung sau. Äoáº¡n vÄƒn (chá»— trá»‘ng lÃ  [BLANK_X]): "${paragraphForAI}" Tá»« há»c sinh Ä‘iá»n (thá»© tá»± BLANK_1, 2,...): ${answers.join(' | ')} Chá»‰ tráº£ lá»i theo 1 trong 2 dáº¡ng sau ÄÃšNG HOÃ€N TOÃ€N: 1. Náº¿u Táº¤T Cáº¢ Ä‘á»u Ä‘Ãºng vÃ  phÃ¹ há»£p: Tráº£ lá»i duy nháº¥t "ÄÃ¡nh giÃ¡: ÄÃºng. Táº¥t cáº£ Ä‘á»u phÃ¹ há»£p." 2. Náº¿u cÃ³ Ã­t nháº¥t Má»˜T lá»—i: Tráº£ lá»i "ÄÃ¡nh giÃ¡: Sai." vÃ  ngay sau Ä‘Ã³ liá»‡t kÃª NGáº®N Gá»ŒN lá»—i á»Ÿ tá»«ng vá»‹ trÃ­ [BLANK_X] (vÃ­ dá»¥: "[BLANK_1]: Sai, nÃªn dÃ¹ng 'tá»« khÃ¡c'. [BLANK_3]: KhÃ´ng há»£p lÃ½."). KHÃ”NG giáº£i thÃ­ch dÃ i dÃ²ng hay phÃ¢n tÃ­ch cÃ¡c pháº§n Ä‘Ãºng náº¿u cÃ³ lá»—i.`; let isCorrect = false; let explanation = "CÃ³ lá»—i xáº£y ra khi kiá»ƒm tra."; const joinedAnswers = answers.join('; '); try { const aiResult = await callAI(prompt); isCorrect = aiResult.isCorrect; explanation = aiResult.explanation; showFeedback(isCorrect, explanation); recordResult(isCorrect, 2, joinedAnswers, isCorrect ? '' : explanation); if (isCorrect) { stopTimer(); showSummary(); submitButton.classList.add('hidden'); hintButtonEl()?.classList.add('hidden'); } else { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i âœ…"; } } catch (error) { if (!feedbackSectionEl()?.textContent) { showFeedback(false, `Lá»—i khi kiá»ƒm tra: ${error.message}`); } submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm tra láº¡i âœ…"; recordResult(false, 2, joinedAnswers, `Lá»—i API: ${error.message}`); } }

         // --- HÃ m gá»­i káº¿t quáº£ lÃªn Google Form (Tá»° Äá»˜NG) ---
         async function submitResultsToGoogleForm() { // ThÃªm async
             console.log("Attempting to automatically submit results to Google Form...");
             const submitButton = getEl('submit-report-button');
             if (submitButton) {
                 submitButton.disabled = true;
                 submitButton.textContent = "Äang ná»™p bÃ¡o cÃ¡o...";
                 submitButton.style.backgroundColor = '#ffc107'; // MÃ u vÃ ng chá»
             }

             if (GOOGLE_FORM_ACTION_URL === "https://docs.google.com/forms/d/e/YOUR_FORM_ID_HERE/formResponse" || !GOOGLE_FORM_ACTION_URL) { alert("Lá»—i cáº¥u hÃ¬nh: ChÆ°a Ä‘áº·t URL action cho Google Form."); if(submitButton){submitButton.disabled=false; submitButton.textContent="Lá»—i Cáº¥u HÃ¬nh Form"; submitButton.style.backgroundColor = '#dc3545';} return; }
             if (STUDENT_NAME_ENTRY_ID === "entry.XXXXXXXXXX") { alert("Lá»—i cáº¥u hÃ¬nh: ChÆ°a Ä‘áº·t Entry ID cho Google Form."); if(submitButton){submitButton.disabled=false; submitButton.textContent="Lá»—i Cáº¥u HÃ¬nh Form"; submitButton.style.backgroundColor = '#dc3545';} return; }

             const nameValue = playerName || "áº¨n danh";
             const timeValue = gameResults.totalTime || "N/A";
             const correctValue = gameResults.correct !== undefined ? gameResults.correct : "N/A";
             const incorrectValue = gameResults.incorrect !== undefined ? gameResults.incorrect : "N/A";
             const errorsString = (gameResults.errors && gameResults.errors.length > 0) ? gameResults.errors.map((err, index) => `${index + 1}. Pháº§n ${err.part}: ${err.issue}\n   (Input: ${err.input || 'N/A'})`).join('\n\n') : "KhÃ´ng cÃ³ lá»—i sai.";

             const formData = new FormData(); // Sá»­ dá»¥ng FormData cho POST
             formData.append(STUDENT_NAME_ENTRY_ID, nameValue);
             formData.append(TOTAL_TIME_ENTRY_ID, timeValue);
             formData.append(CORRECT_COUNT_ENTRY_ID, correctValue.toString());
             formData.append(INCORRECT_COUNT_ENTRY_ID, incorrectValue.toString());
             formData.append(ERRORS_LIST_ENTRY_ID, errorsString);

             console.log("Submitting to Google Form URL:", GOOGLE_FORM_ACTION_URL);
             console.log("Data:", { name: nameValue, time: timeValue, correct: correctValue, incorrect: incorrectValue, errors: errorsString });

             try {
                 // Gá»­i dá»¯ liá»‡u áº©n báº±ng fetch POST, khÃ´ng má»Ÿ tab má»›i
                 // mode: 'no-cors' cÃ³ nghÄ©a lÃ  chÃºng ta khÃ´ng thá»ƒ Ä‘á»c response tá»« server Google,
                 // nhÆ°ng request váº«n Ä‘Æ°á»£c gá»­i Ä‘i. ÄÃ¢y lÃ  cÃ¡ch phá»• biáº¿n Ä‘á»ƒ submit form client-side.
                 const response = await fetch(GOOGLE_FORM_ACTION_URL, {
                     method: 'POST',
                     mode: 'no-cors', // QUAN TRá»ŒNG
                     body: formData
                 });

                 // VÃ¬ dÃ¹ng 'no-cors', chÃºng ta khÃ´ng thá»ƒ kiá»ƒm tra response.status hay response.ok
                 // ChÃºng ta giáº£ Ä‘á»‹nh lÃ  thÃ nh cÃ´ng náº¿u khÃ´ng cÃ³ lá»—i network.
                 console.log("Form data submitted via POST (no-cors). Success assumed.");
                 alert("ÄÃ£ tá»± Ä‘á»™ng gá»­i bÃ¡o cÃ¡o thÃ nh cÃ´ng! Cáº£m Æ¡n báº¡n.");
                 if (submitButton) {
                     submitButton.textContent = "ÄÃ£ Ná»™p Tá»± Äá»™ng âœ…";
                     submitButton.style.backgroundColor = '#28a745'; // MÃ u xanh thÃ nh cÃ´ng
                     // Báº¡n cÃ³ thá»ƒ giá»¯ nÃºt bá»‹ vÃ´ hiá»‡u hÃ³a hoáº·c lÃ m gÃ¬ Ä‘Ã³ khÃ¡c
                 }

             } catch (error) {
                 console.error("Error submitting to Google Form via POST:", error);
                 alert("Gá»­i bÃ¡o cÃ¡o tá»± Ä‘á»™ng tháº¥t báº¡i. Lá»—i: " + error.message + "\nVui lÃ²ng thá»­ láº¡i báº±ng cÃ¡ch nháº¥n nÃºt 'Ná»™p BÃ¡o CÃ¡o' láº§n ná»¯a (sáº½ má»Ÿ link) hoáº·c liÃªn há»‡ giÃ¡o viÃªn. Báº¡n cÃ³ thá»ƒ chá»¥p áº£nh mÃ n hÃ¬nh káº¿t quáº£ nÃ y.");
                 // Náº¿u gá»­i tá»± Ä‘á»™ng lá»—i, cÃ³ thá»ƒ fallback vá» cÃ¡ch má»Ÿ link:
                 // const fallbackUrl = `${GOOGLE_FORM_ACTION_URL}?${new URLSearchParams(Object.fromEntries(formData)).toString()}`;
                 // window.open(fallbackUrl, '_blank');
                 // alert("Do gá»­i tá»± Ä‘á»™ng lá»—i, Ä‘Ã£ má»Ÿ tab Google Form. Vui lÃ²ng kiá»ƒm tra vÃ  nháº¥n 'Gá»­i' trÃªn trang Ä‘Ã³ nhÃ©!");

                 if (submitButton) {
                     submitButton.disabled = false; // Cho phÃ©p thá»­ láº¡i
                     submitButton.textContent = "Ná»™p BÃ¡o CÃ¡o (Thá»­ láº¡i)";
                     submitButton.style.backgroundColor = '#dc3545'; // MÃ u Ä‘á» lá»—i
                 }
             }
         }


        // --- Summary Page ---
        function showSummary() { const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl(); if (!currentgameContainerEl || !currentsummaryPageEl) return; currentgameContainerEl.classList.add('hidden'); currentsummaryPageEl.style.display = 'block'; currentsummaryPageEl.classList.remove('hidden'); const summaryPlayerNameEl = getEl('summary-player-name'); const summaryTimeEl = getEl('summary-time'); const summaryCorrectEl = getEl('summary-correct'); const summaryIncorrectEl = getEl('summary-incorrect'); const errorsListEl = getEl('summary-errors'); const restartButton = getEl('restart-button'); if(summaryPlayerNameEl) summaryPlayerNameEl.textContent = playerName || "áº¨n danh"; if(summaryTimeEl) summaryTimeEl.textContent = gameResults.totalTime || 'N/A'; if(summaryCorrectEl) summaryCorrectEl.textContent = gameResults.correct || 0; if(summaryIncorrectEl) summaryIncorrectEl.textContent = gameResults.incorrect || 0; if(errorsListEl) { errorsListEl.innerHTML = ''; if (gameResults.errors && gameResults.errors.length > 0) { gameResults.errors.forEach(err => { const li = document.createElement('li'); const shortInput = err.input && err.input.length > 100 ? err.input.substring(0, 97) + '...' : err.input; li.innerHTML = `<strong>Pháº§n ${err.part}:</strong> ${err.issue} <br><small>(Input: ${shortInput || 'N/A'})</small>`; errorsListEl.appendChild(li); }); } else { errorsListEl.innerHTML = '<li>ChÃºc má»«ng! Báº¡n khÃ´ng máº¯c lá»—i nÃ o cáº£! âœ¨</li>'; } } else { console.error("Error list element not found in summary page."); } const submitReportButton = getEl('submit-report-button'); if (submitReportButton) { submitReportButton.disabled = false; submitReportButton.textContent = "Ná»™p BÃ¡o CÃ¡o LÃªn Google Form ğŸ“‹"; submitReportButton.style.backgroundColor = '#28a745'; submitReportButton.onclick = submitResultsToGoogleForm; } else { console.error("Submit report button not found in summary page."); } if (restartButton && !restartButton.dataset.listenerAttached) { restartButton.addEventListener('click', initGame); restartButton.dataset.listenerAttached = 'true'; } else if (!restartButton) { console.error("Restart button not found in summary page."); } }

        // --- Initialization ---
        function initGame() { console.log("Initializing new game with Gemini Flash AI + Google Form Auto Submit..."); currentPart = 0; gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00' }; playerName = ""; if (timerInterval) clearInterval(timerInterval); timerInterval = null; const currentTimerEl = timerEl(); if(currentTimerEl) currentTimerEl.textContent = '00:00'; const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl(); const currentgameAreaEl = gameAreaEl(); const currentNextButtonEl = nextButtonEl(); const currentInstructionsEl = instructionsEl(); if(currentgameContainerEl) currentgameContainerEl.classList.remove('hidden'); if(currentsummaryPageEl) currentsummaryPageEl.style.display = 'none'; if(currentgameAreaEl) currentgameAreaEl.innerHTML = ''; clearFeedback(); clearHint(); if(currentNextButtonEl) currentNextButtonEl.classList.add('hidden'); hideTooltip(); if (currentInstructionsEl) currentInstructionsEl.innerHTML = '<p>ğŸ‘‹ ChÃ o báº¡n! Vui lÃ²ng nháº­p tÃªn Ä‘á»ƒ báº¯t Ä‘áº§u.</p>'; if (currentgameAreaEl) { currentgameAreaEl.innerHTML = ` <div id="player-info" style="margin-bottom: 15px; padding: 20px; background-color: #e0f7fa; border-radius: 8px;"> <label for="player-name" style="display: block; margin-bottom: 8px; font-weight: bold;">TÃªn cá»§a báº¡n:</label> <input type="text" id="player-name" placeholder="Nháº­p tÃªn cá»§a báº¡n..." required style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;"> <button id="start-game-button" style="padding: 10px 20px;">Báº¯t Ä‘áº§u chÆ¡i!</button> </div> `; const startButton = getEl('start-game-button'); const playerNameInput = getEl('player-name'); if (startButton && playerNameInput) { playerNameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); startButton.click(); } }); startButton.addEventListener('click', () => { const name = playerNameInput.value.trim(); if (!name) { alert("Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n!"); return; } playerName = name; console.log("Player Name:", playerName); loadPart1(); startTimer(); }); } else { console.error("KhÃ´ng tÃ¬m tháº¥y nÃºt báº¯t Ä‘áº§u hoáº·c Ã´ nháº­p tÃªn."); } } else { console.error("Game area element not found for player info."); } const currentHintButtonEl = hintButtonEl(); if (currentHintButtonEl && !currentHintButtonEl.dataset.listenerAttached) { currentHintButtonEl.addEventListener('click', showHint); currentHintButtonEl.dataset.listenerAttached = 'true'; } else if (currentHintButtonEl) { currentHintButtonEl.classList.remove('hidden'); currentHintButtonEl.disabled = false; } else { console.warn("Hint button not found during init."); } }

        // ----- START GAME -----
        document.addEventListener('DOMContentLoaded', initGame);

    </script>
</body>
</html>
