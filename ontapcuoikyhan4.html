<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HSK 4–5 | Ôn ngữ pháp + Làm bài (Offline)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121c30; --panel2:#0f172a;
      --text:#e6eefc; --muted:#a9b6d3; --line:#24314f;
      --accent:#7c3aed; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px; --radius2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #050814 85%);
    }
    .app{display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:16px; max-width: 1400px; margin:0 auto;}
    @media (max-width: 980px){ .app{grid-template-columns: 1fr} .sidebar{position:relative;height:auto} }
    .sidebar{
      background: rgba(18,28,48,.85); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:14px; position: sticky; top: 12px;
      height: calc(100vh - 24px); overflow:auto; backdrop-filter: blur(10px);
    }
    .main{
      background: rgba(15,23,42,.75); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:18px; overflow:hidden; backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:10px;border-bottom:1px solid var(--line);margin-bottom:10px;}
    .brand h1{font-size:16px;margin:0;line-height:1.2}
    .brand small{display:block;color:var(--muted);margin-top:4px}
    .pill{
      font-family:var(--mono); font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background: rgba(255,255,255,.04); color: var(--muted);
      white-space:nowrap; height: fit-content;
    }
    .nav{display:flex;flex-direction:column;gap:8px;padding:10px;}
    .nav button{
      width:100%; text-align:left; border:1px solid var(--line); background: rgba(255,255,255,.03);
      color: var(--text); padding:10px 12px; border-radius: 12px; cursor:pointer; transition:.15s ease;
    }
    .nav button:hover{transform: translateY(-1px); background: rgba(255,255,255,.05)}
    .nav button.active{border-color: rgba(124,58,237,.8); box-shadow: 0 0 0 3px rgba(124,58,237,.15) inset}
    .sub{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .tag{font-size:12px;color:var(--muted); border:1px solid var(--line); background: rgba(255,255,255,.02); padding:3px 8px;border-radius:999px}

    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding-bottom:12px;border-bottom:1px solid var(--line); margin-bottom:14px;
    }
    .progressWrap{
      width:min(560px, 100%); background: rgba(255,255,255,.04); border:1px solid var(--line);
      border-radius:999px; overflow:hidden; height:12px;
    }
    .progressBar{height:100%; width:0%; background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(34,197,94,.9));}
    .kpi{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .kpi .box{
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      padding:8px 10px; border-radius: 12px; min-width: 120px;
    }
    .kpi .box b{display:block;font-size:14px}
    .kpi .box span{color:var(--muted);font-size:12px}

    .btn{
      border:1px solid var(--line); background: rgba(255,255,255,.03); color:var(--text);
      padding:10px 12px; border-radius: 12px; cursor:pointer; transition:.15s ease;
      display:inline-flex;align-items:center;gap:8px
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.05)}
    .btn.primary{border-color: rgba(124,58,237,.8); background: rgba(124,58,237,.18)}
    .btn.good{border-color: rgba(34,197,94,.8); background: rgba(34,197,94,.14)}
    .btn.danger{border-color: rgba(239,68,68,.8); background: rgba(239,68,68,.12)}
    .btn.warn{border-color: rgba(245,158,11,.8); background: rgba(245,158,11,.10)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .sectionTitle{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px;margin-bottom:10px}
    .sectionTitle h2{margin:0;font-size:18px}
    .sectionTitle p{margin:0;color:var(--muted);font-size:13px}
    .card{
      border:1px solid var(--line); background: rgba(11,20,40,.65);
      border-radius: var(--radius2); padding:14px; margin: 12px 0;
    }
    .review h3{margin:0 0 8px 0; font-size:14px}
    .review ul{margin:8px 0 0 18px; color:var(--muted)}
    .review li{margin:6px 0}
    .ex{
      border:1px dashed rgba(169,182,211,.35); border-radius: 12px;
      padding:10px 12px; margin-top:10px; background: rgba(255,255,255,.02);
    }
    .ex .cn{font-size:15px; line-height:1.4}
    .ex .py{font-family: var(--mono); color: #cbd5e1; opacity:.92; margin-top:6px; font-size:12.5px}
    .ex .vi{color:var(--muted); margin-top:4px; font-size:13px}

    .q{
      border:1px solid rgba(36,49,79,.9); background: rgba(255,255,255,.02);
      border-radius: 14px; padding:12px; margin: 10px 0;
    }
    .qhead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .qnum{
      font-family: var(--mono); color: var(--muted); font-size:12px;
      padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .badge{
      font-family: var(--mono); font-size: 12px; border:1px solid var(--line);
      background: rgba(255,255,255,.02); padding:4px 8px; border-radius: 999px; color: var(--muted);
    }
    .badge.good{border-color: rgba(34,197,94,.8); color: rgba(34,197,94,.95)}
    .badge.bad{border-color: rgba(239,68,68,.8); color: rgba(239,68,68,.95)}
    .badge.warn{border-color: rgba(245,158,11,.8); color: rgba(245,158,11,.95)}
    .qtext{margin:8px 0 8px 0; font-size:15px; line-height:1.55}

    .opts{display:grid;gap:8px; margin-top:8px}
    .opt{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line); background: rgba(255,255,255,.02);
      padding:10px 10px; border-radius: 12px; cursor:pointer; user-select:none; transition:.12s ease;
    }
    .opt:hover{background: rgba(255,255,255,.04)}
    .opt input{margin-top:2px}
    .opt.correct{border-color: rgba(34,197,94,.85); background: rgba(34,197,94,.10)}
    .opt.wrong{border-color: rgba(239,68,68,.85); background: rgba(239,68,68,.08)}

    .inline{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px}
    input[type="text"]{
      width:min(460px, 100%); padding:10px 12px; border-radius: 12px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); color: var(--text); outline:none;
    }
    input[type="text"]:focus{box-shadow: 0 0 0 3px rgba(124,58,237,.18) inset; border-color: rgba(124,58,237,.7)}
    .hint{color: var(--muted); font-size: 13px; margin-top: 8px; line-height:1.5;}
    .divider{height:1px;background: var(--line); margin: 14px 0}

    .chipsRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      border:1px solid var(--line); background: rgba(255,255,255,.02);
      padding:10px 10px; border-radius: 12px; cursor:grab; user-select:none; font-family: var(--mono); font-size: 13px;
    }
    .chip:active{cursor:grabbing}
    .dropHint{color: var(--muted); font-size: 12.5px; margin-top: 8px;}

    .examBanner{
      display:none; border:1px solid rgba(245,158,11,.5); background: rgba(245,158,11,.10);
      border-radius: 14px; padding:12px; margin-bottom:12px;
    }
    .examBanner b{display:block}
    .examBanner .muted{color:var(--muted); font-size:13px; margin-top:6px}
    .timer{
      font-family: var(--mono); padding:6px 10px; border-radius:999px;
      border:1px solid rgba(245,158,11,.55); background: rgba(245,158,11,.10); color: #fde68a;
      display:inline-flex; gap:8px; align-items:center; margin-top:8px;
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div>
        <h1>HSK 4–5 • Offline</h1>
        <small>Ôn ngữ pháp nhanh • Làm bài trực tiếp • Ôn thi</small>
      </div>
      <div class="pill" id="saveStatus">Saved</div>
    </div>

    <div class="card">
      <b>Chế độ</b>
      <div class="hint">Ôn thi sẽ ẩn phần ôn nhanh và tắt đáp án, bật giờ.</div>
      <div class="inline" style="margin-top:10px">
        <button class="btn warn" id="startExamBtn">Bắt đầu ôn thi (45 phút)</button>
        <button class="btn danger" id="endExamBtn" style="display:none">Thoát ôn thi</button>
      </div>
      <div class="inline" style="margin-top:10px">
        <button class="btn primary" id="submitExamBtn" style="display:none">Nộp bài</button>
      </div>
      <div class="divider"></div>
      <div class="inline">
        <button class="btn" id="togglePinyin">Pinyin: ON</button>
        <button class="btn warn" id="toggleAnswers">Đáp án: OFF</button>
      </div>
      <div class="inline" style="margin-top:10px">
        <button class="btn" id="exportJSON">Xuất bài (JSON)</button>
        <button class="btn danger" id="resetAll">Xoá tiến độ</button>
      </div>
    </div>

    <div class="nav" id="nav"></div>
  </aside>

  <main class="main">
    <div class="examBanner" id="examBanner">
      <b>ÔN THI đang bật</b>
      <div class="muted">Trong ôn thi: ẩn “Ôn ngữ pháp nhanh”, tắt đáp án. Nộp bài để xem điểm.</div>
      <div class="timer" id="timer">⏱ 45:00</div>
    </div>

    <div class="topbar">
      <div class="left" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="progressWrap" aria-label="progress">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="kpi">
          <div class="box">
            <b id="kpiDone">0 / 0</b>
            <span>đã làm (có lưu)</span>
          </div>
          <div class="box">
            <b id="kpiScore">0/0</b>
            <span>điểm (auto-graded)</span>
          </div>
          <div class="box">
            <b id="kpiAcc">0%</b>
            <span>độ đúng (graded)</span>
          </div>
        </div>
      </div>
      <div class="inline">
        <button class="btn primary" id="gradeAll">Chấm tất cả</button>
      </div>
    </div>

    <div class="sectionTitle">
      <div>
        <h2 id="sectionName">—</h2>
        <p id="sectionDesc">—</p>
      </div>
      <div class="sub" id="sectionTags"></div>
    </div>

    <div id="content"></div>
  </main>
</div>

<script>
/* =========================
   DATA
   ========================= */
const SECTIONS = [
  {
    id: "A",
    name: "A. Trắc nghiệm ngữ pháp",
    desc: "22 câu • chọn đáp án đúng nhất",
    tags: ["MCQ", "HSK4–5", "Auto-graded"],
    review: {
      title: "ÔN NGỮ PHÁP NHANH",
      points: [
        "尽管/虽然…但是/可是/却…: nhượng bộ “dù… nhưng…”",
        "只要…就…: điều kiện “chỉ cần… thì…”",
        "并不/并没有/并不是: phủ định nhấn mạnh",
        "反而: kết quả/đánh giá trái dự đoán"
      ],
      examples: [
        { cn:"尽管很累，他还是坚持学习。", py:"Jǐnguǎn hěn lèi, tā háishi jiānchí xuéxí.", vi:"Dù mệt anh ấy vẫn kiên trì học." },
        { cn:"只要每天复习，就会进步。", py:"Zhǐyào měitiān fùxí, jiù huì jìnbù.", vi:"Chỉ cần ôn mỗi ngày thì sẽ tiến bộ." }
      ]
    },
    questions: [
      { id:1, type:"mcq", text:"他 ___ 工作很忙，___ 每天都坚持锻炼身体。", opts:["尽管 / 但是","即使 / 也","不仅 / 而且","虽然 / 为了"], ans:0 },
      { id:2, type:"mcq", text:"我刚到公司，经理 ___ 让我去他的办公室。", opts:["立刻","逐渐","反而","曾经"], ans:0 },
      { id:3, type:"mcq", text:"对学生 ___，老师的鼓励非常重要。", opts:["来说","看来","上","下"], ans:0 },
      { id:4, type:"mcq", text:"这道题太简单了，你 ___ 不会做吧？", opts:["居然","毕竟","或许","从而"], ans:0 },
      { id:5, type:"mcq", text:"___ 已经下班了，他 ___ 还在公司加班。", opts:["即使 / 也","虽然 / 却","不管 / 都","因为 / 所以"], ans:1 },
      { id:6, type:"mcq", text:"他原来以为汉语很难，学了以后 ___ 觉得很有意思。", opts:["并","却","反而","于是"], ans:2 },
      { id:7, type:"mcq", text:"由于天气原因，航班被取消，___ 我们只好改签。", opts:["因此","反而","甚至","通过"], ans:0 },
      { id:8, type:"mcq", text:"他 ___ 不是不想帮你，只是实在太忙了。", opts:["并","却","反而","居然"], ans:0 },
      { id:9, type:"mcq", text:"___ 努力学习，___ 能取得好成绩。", opts:["只要 / 就","尽管 / 但是","即使 / 也","不但 / 而且"], ans:0 },
      { id:10, type:"mcq", text:"这条路 ___ 修好，交通就方便多了。", opts:["一旦","逐渐","已经","临"], ans:0 },
      { id:11, type:"mcq", text:"这本书内容很丰富，___ 适合中级学习者。", opts:["因此","尤其","再说","分别"], ans:0 },
      { id:12, type:"mcq", text:"这件事情 ___ 看，并没有那么复杂。", opts:["在我看来","对我来说","在我来说","对我看来"], ans:0 },
      { id:13, type:"mcq", text:"这么重要的决定，你 ___ 不跟家人商量一下？", opts:["难道","何必","或许","何况"], ans:0 },
      { id:14, type:"mcq", text:"比赛结束后，队员们 ___ 回到休息室。", opts:["纷纷","渐渐","原来","各自"], ans:0 },
      { id:15, type:"mcq", text:"这份工作虽然辛苦，___ 很有挑战性。", opts:["反而","从而","因此","甚至"], ans:0 },
      { id:16, type:"mcq", text:"他做事 ___ 不认真，___ 动作很慢。", opts:["既 / 又","虽然 / 但是","不管 / 都","即使 / 也"], ans:0 },
      { id:17, type:"mcq", text:"这部电影内容深刻，很 ___ 一看。", opts:["值得","来不及","正好","逐渐"], ans:0 },
      { id:18, type:"mcq", text:"我刚想给你打电话，你 ___ 就来了。", opts:["正好","毕竟","从来","分别"], ans:0 },
      { id:19, type:"mcq", text:"时间太紧了，我们 ___ 吃早饭就出门了。", opts:["来不及","甚至","逐渐","通过"], ans:0 },
      { id:20, type:"mcq", text:"看起来简单，___ 并不容易解决。", opts:["实际上","原来","从而","逐渐"], ans:0 },
      { id:21, type:"mcq", text:"他不仅会说汉语，___ 会写汉字。", opts:["而且","但是","因此","否则"], ans:0 },
      { id:22, type:"mcq", text:"你 ___ 早点告诉我，我就不会这么着急了。", opts:["要是","尽管","反而","分别"], ans:0 }
    ]
  },
  {
    id: "B",
    name: "B. Điền từ",
    desc: "12 câu • điền 1 từ phù hợp",
    tags: ["Fill", "Auto-graded"],
    review: {
      title: "ÔN NGỮ PHÁP NHANH",
      points: [
        "来不及 + V: không kịp làm gì",
        "正好: đúng lúc",
        "逐渐: dần dần",
        "甚至: thậm chí",
        "原来: hóa ra (phát hiện mới)"
      ],
      examples: [
        { cn:"再不走就来不及了。", py:"Zài bù zǒu jiù láibují le.", vi:"Không đi nữa là không kịp." },
        { cn:"你来得正好，我们开始吧。", py:"Nǐ lái de zhènghǎo, wǒmen kāishǐ ba.", vi:"Bạn tới đúng lúc, bắt đầu nhé." }
      ]
    },
    questions: [
      {id:23, type:"fill", text:"___ 下雨了，我们还是决定出门。", ans:["尽管"]},
      {id:24, type:"fill", text:"资料很清楚，___ 大家都能理解。", ans:["因此"]},
      {id:25, type:"fill", text:"这部电影很 ___ 一看。", ans:["值得"]},
      {id:26, type:"fill", text:"我刚想找你，你 ___ 就来了。", ans:["正好"]},
      {id:27, type:"fill", text:"时间太紧，我们 ___ 吃早饭就出门了。", ans:["来不及"]},
      {id:28, type:"fill", text:"他很忙，___ 连午饭都没吃。", ans:["甚至"]},
      {id:29, type:"fill", text:"刚开始不习惯，后来 ___ 就好了。", ans:["逐渐"]},
      {id:30, type:"fill", text:"他以为会失败，___ 成功了。", ans:["反而"]},
      {id:31, type:"fill", text:"___ 下雨，我也要去上课。", ans:["即使"]},
      {id:32, type:"fill", text:"我以为他是学生，___ 他是老师。", ans:["原来"]},
      {id:33, type:"fill", text:"他说得很有道理，___ 大家都同意他的意见。", ans:["因此"]},
      {id:34, type:"fill", text:"这件事并 ___ 难，只要认真做就行。", ans:["不"]}
    ]
  },
  {
    id:"C",
    name:"C. Sắp xếp từ thành câu",
    desc:"10 câu • kéo thả để sắp xếp",
    tags:["Reorder","Auto-graded"],
    review:{
      title:"ÔN NGỮ PHÁP NHANH",
      points:[
        "Khung câu thường: (thời gian/địa điểm) → chủ ngữ → trạng ngữ → động từ → tân ngữ → bổ ngữ",
        "Cụm điều kiện/nhượng bộ hay đứng đầu: 只要/尽管/即使/不管…",
        "Cụm nêu quan điểm: 在…看来 / 对…来说"
      ],
      examples:[
        { cn:"只要你坚持练习，就一定会进步。", py:"Zhǐyào nǐ jiānchí liànxí, jiù yídìng huì jìnbù.", vi:"Chỉ cần kiên trì luyện tập thì sẽ tiến bộ." }
      ]
    },
    questions:[
      {id:35, type:"reorder", tokens:["在","我","看来","这个问题","不难"], ans:"在我看来这个问题不难"},
      {id:36, type:"reorder", tokens:["只要","坚持","就","能","成功"], ans:"只要坚持就能成功"},
      {id:37, type:"reorder", tokens:["尽管","很","累","他","还是","学习"], ans:"尽管很累他还是学习"},
      {id:38, type:"reorder", tokens:["他","并","不","想","放弃"], ans:"他并不想放弃"},
      {id:39, type:"reorder", tokens:["我","刚","到","他","立刻","走","了"], ans:"我刚到他立刻走了"},
      {id:40, type:"reorder", tokens:["不管","多","难","我","都","坚持"], ans:"不管多难我都坚持"},
      {id:41, type:"reorder", tokens:["对","我","来说","时间","很","重要"], ans:"对我来说时间很重要"},
      {id:42, type:"reorder", tokens:["他","越","紧张","反而","越","说不清"], ans:"他越紧张反而越说不清"},
      {id:43, type:"reorder", tokens:["结果","下雨","比赛","取消","了"], ans:"结果下雨比赛取消了"},
      {id:44, type:"reorder", tokens:["原来","你","也","在","这里"], ans:"原来你也在这里"}
    ]
  },
  {
    id:"D",
    name:"D. Đọc hiểu",
    desc:"1 bài ~400 chữ • 8 câu ABCD",
    tags:["Reading","Auto-graded"],
    review:{
      title:"ÔN NGỮ PHÁP NHANH",
      points:[
        "Đọc câu hỏi trước → quay lại tìm câu chứa thông tin.",
        "Nhìn từ nối: 结果/因此/不过/虽然…但是… để bắt ý chính.",
        "Câu kết luận thường ở cuối đoạn."
      ],
      examples:[]
    },
    passage:{
      title:"Bài đọc (khoảng 400 chữ)",
      cn:
"我第一次认真准备HSK考试，是在一个学期特别忙的时候。白天要上课、写作业，晚上还要兼职。刚开始我以为只要背单词就够了，结果做阅读时总是抓不住重点，写作也常常用很多口语表达，分数并不理想。后来老师提醒我：词汇当然重要，但语法能帮助你把句子说清楚，尤其在写作部分更明显。于是我把复习方法改成三步：先用十分钟回顾当天的语法点，再做一套小题检查漏洞，最后用同一个主题写八十到一百字的小段落。为了避免写到一半卡住，我还提前准备一些连接词，比如“尽管…但是…”、“因此”、“从而”。坚持两周后，我发现自己读文章时更容易找到转折词和结论句，做题速度也逐渐快了。更重要的是，我开始享受这种“越练越顺”的感觉。虽然离目标分数还有距离，但我相信只要继续保持节奏，结果一定会比以前好。",
      py:
"Wǒ dì yī cì rènzhēn zhǔnbèi HSK kǎoshì, shì zài yí gè xuéqī tèbié máng de shíhou... (pinyin dài — có thể tắt pinyin để dễ đọc)",
      questions:[
        {id:45, type:"mcq", text:"Tác giả chuẩn bị HSK vào thời điểm nào?", opts:["Khi rất rảnh","Khi một học kỳ đặc biệt bận","Khi đã nghỉ học","Khi đi du lịch"], ans:1},
        {id:46, type:"mcq", text:"Vì sao điểm ban đầu không lý tưởng?", opts:[
          "Vì không học từ vựng",
          "Vì chỉ dựa vào từ vựng, đọc không nắm trọng điểm và viết dùng nhiều khẩu ngữ",
          "Vì không làm bài nghe",
          "Vì đề quá dễ"
        ], ans:1},
        {id:47, type:"mcq", text:"Theo giáo viên, ngữ pháp giúp điều gì nhất?", opts:[
          "Giúp viết chữ đẹp hơn","Giúp câu rõ ràng, đặc biệt phần viết","Giúp nhớ từ nhanh hơn","Giúp nghe giỏi ngay"
        ], ans:1},
        {id:48, type:"mcq", text:"Ba bước ôn tập mới của tác giả là gì?", opts:[
          "Nghe–nói–đọc","Chỉ làm đề","Ôn ngữ pháp 10 phút → làm bài nhỏ → viết đoạn 80–100 chữ","Học thuộc bài mẫu"
        ], ans:2},
        {id:49, type:"mcq", text:"Chuẩn bị “连接词” để làm gì?", opts:[
          "Để nói chuyện nhanh hơn","Để tránh viết giữa chừng bị kẹt","Để tăng số lượng từ vựng","Để làm bài nghe"
        ], ans:1},
        {id:50, type:"mcq", text:"Sau 2 tuần, kỹ năng đọc thay đổi thế nào?", opts:[
          "Không thay đổi","Dễ tìm từ chuyển ý và câu kết luận hơn","Chỉ nhớ thêm từ vựng","Đọc chậm hơn"
        ], ans:1},
        {id:51, type:"mcq", text:"Tác giả cảm thấy thế nào về việc luyện tập?", opts:[
          "Ghét luyện tập","Bắt đầu tận hưởng cảm giác càng luyện càng trôi chảy","Không quan tâm","Muốn bỏ thi"
        ], ans:1},
        {id:52, type:"mcq", text:"Kết luận của đoạn là gì?", opts:[
          "Chỉ cần nghỉ ngơi là đủ","Giữ nhịp ôn tập thì kết quả sẽ tốt hơn trước","Không cần học nữa","Kết quả chắc chắn kém"
        ], ans:1}
      ]
    }
  }
];

/* =========================
   STORAGE STATE
   ========================= */
const STORAGE_KEY = "hsk_offline_practice_simple_v1";

let state = loadState() || {
  sectionId: "A",
  showPinyin: true,
  showAnswers: false,
  answers: {},
  exam: { active:false, durationMin:45, startedAt:null, submitted:false, order:null },
  lastSaved: Date.now()
};

function saveState(){
  state.lastSaved = Date.now();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  flashSaved();
  updateKPIs();
  renderNav();
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function flashSaved(){
  const el = document.getElementById("saveStatus");
  el.textContent = "Saved";
  el.style.borderColor = "rgba(34,197,94,.8)";
  el.style.color = "rgba(34,197,94,.95)";
  setTimeout(()=>{
    el.style.borderColor = "var(--line)";
    el.style.color = "var(--muted)";
  }, 650);
}
function keyOf(sectionId, qid){ return `${sectionId}-${qid}`; }

/* =========================
   UTIL
   ========================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================
   ORDER
   ========================= */
function getQuestionsInSection(secId){
  const sec = SECTIONS.find(s=>s.id===secId);
  if(!sec) return [];
  if(secId==="D") return sec.passage.questions;
  return sec.questions;
}
function getQuestionById(secId, id){
  const list = getQuestionsInSection(secId);
  return list.find(q=>q.id===id);
}
function getOrderedIds(secId){
  const list = getQuestionsInSection(secId);
  if(!state.exam.active || !state.exam.order || !state.exam.order[secId]) return list.map(q=>q.id);
  return state.exam.order[secId];
}

/* =========================
   GRADING
   ========================= */
function gradeQuestion(secId, q){
  const k = keyOf(secId, q.id);
  const v = state.answers[k];

  if(q.type==="mcq"){
    if(v===undefined) return {graded:false};
    const ok = Number(v)===q.ans;
    return {graded:true, ok, points: ok?1:0, max:1};
  }
  if(q.type==="fill"){
    if(v===undefined) return {graded:false};
    const user = String(v).trim();
    if(!user) return {graded:false};
    const ok = q.ans.some(a=>a===user);
    return {graded:true, ok, points: ok?1:0, max:1};
  }
  if(q.type==="reorder"){
    if(v===undefined) return {graded:false};
    const user = String(v).split("|").join("").replace(/\s+/g,"").trim();
    if(!user) return {graded:false};
    const ok = user === q.ans.replace(/\s+/g,"").trim();
    return {graded:true, ok, points: ok?1:0, max:1};
  }
  return {graded:false};
}
function gradeAll(){
  let points=0, max=0;
  ["A","B","C","D"].forEach(secId=>{
    const ids = getOrderedIds(secId);
    ids.forEach(id=>{
      const q = getQuestionById(secId,id);
      const g = gradeQuestion(secId,q);
      if(g.graded){ points += g.points; max += g.max; }
    });
  });
  return {points, max};
}

/* =========================
   KPIs
   ========================= */
function countTotalAll(){
  let total=0;
  ["A","B","C","D"].forEach(secId=> total += getQuestionsInSection(secId).length);
  return total;
}
function countDoneAll(){
  let c=0;
  ["A","B","C","D"].forEach(secId=>{
    getQuestionsInSection(secId).forEach(q=>{
      const k = keyOf(secId,q.id);
      const v = state.answers[k];
      if(v!==undefined && v!==null && String(v).trim()!=="") c++;
    });
  });
  return c;
}
function updateKPIs(){
  const done = countDoneAll();
  const total = countTotalAll();
  document.getElementById("kpiDone").textContent = `${done} / ${total}`;

  const g = gradeAll();
  document.getElementById("kpiScore").textContent = `${g.points}/${g.max}`;
  const acc = g.max ? Math.round((g.points/g.max)*100) : 0;
  document.getElementById("kpiAcc").textContent = `${acc}%`;

  const pct = total ? Math.round((done/total)*100) : 0;
  document.getElementById("progressBar").style.width = pct + "%";
}

/* =========================
   NAV
   ========================= */
const navEl = document.getElementById("nav");
function countTotalInSection(secId){ return getQuestionsInSection(secId).length; }
function countDoneInSection(secId){
  let c=0;
  getQuestionsInSection(secId).forEach(q=>{
    const k = keyOf(secId,q.id);
    const v = state.answers[k];
    if(v!==undefined && v!==null && String(v).trim()!=="") c++;
  });
  return c;
}
function renderNav(){
  navEl.innerHTML = "";
  SECTIONS.forEach(sec=>{
    const btn = document.createElement("button");
    btn.textContent = sec.name;
    btn.className = (sec.id===state.sectionId) ? "active" : "";
    btn.onclick = ()=>{
      state.sectionId = sec.id;
      saveState();
      render();
    };
    const done = countDoneInSection(sec.id);
    const total = countTotalInSection(sec.id);
    const sub = document.createElement("div");
    sub.className = "sub";
    sub.innerHTML = `<span class="tag">${done}/${total} done</span><span class="tag">${total} q</span>`;
    const wrap = document.createElement("div");
    wrap.appendChild(btn);
    wrap.appendChild(sub);
    navEl.appendChild(wrap);
  });
}

/* =========================
   RENDER
   ========================= */
const contentEl = document.getElementById("content");

function updateToggles(){
  document.getElementById("togglePinyin").textContent = `Pinyin: ${state.showPinyin?"ON":"OFF"}`;
  document.getElementById("toggleAnswers").textContent = `Đáp án: ${state.showAnswers?"ON":"OFF"}`;
}

function renderReviewCard(sec){
  const card = document.createElement("div");
  card.className = "card review";
  card.innerHTML = `
    <h3>${sec.review.title}</h3>
    <ul>${sec.review.points.map(p=>`<li>${escapeHtml(p)}</li>`).join("")}</ul>
    <div class="exWrap"></div>
  `;
  const exWrap = card.querySelector(".exWrap");
  (sec.review.examples || []).forEach(ex=>{
    const exDiv = document.createElement("div");
    exDiv.className = "ex";
    exDiv.innerHTML = `
      <div class="cn">${escapeHtml(ex.cn)}</div>
      <div class="py pinyin" style="display:${state.showPinyin?"block":"none"}">${escapeHtml(ex.py)}</div>
      <div class="vi">${escapeHtml(ex.vi)}</div>
    `;
    exWrap.appendChild(exDiv);
  });
  return card;
}

function renderPassage(p){
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <b>${escapeHtml(p.title)}</b>
    <div class="hint" style="margin-top:10px">
      <div style="font-size:15px;line-height:1.6">${escapeHtml(p.cn)}</div>
      <div class="pinyin" style="display:${state.showPinyin?"block":"none"};margin-top:10px;font-family:var(--mono);opacity:.92">${escapeHtml(p.py)}</div>
    </div>
  `;
  return card;
}

function setBadge(secId, qid, type, text){
  const el = document.getElementById(`badge-${secId}-${qid}`);
  if(!el) return;
  el.className = "badge";
  if(type==="good") el.classList.add("good");
  if(type==="bad") el.classList.add("bad");
  if(type==="warn") el.classList.add("warn");
  el.textContent = text;
}

function paintMCQ(secId, q, wrap){
  const k = keyOf(secId,q.id);
  const v = state.answers[k];
  const rows = [...wrap.querySelectorAll(".opt")];
  rows.forEach(r=>r.classList.remove("correct","wrong"));

  if(state.exam.active && !state.exam.submitted){
    setBadge(secId,q.id,"warn", v!=null ? "Đã chọn" : "—");
    return;
  }
  if(v===undefined || v===null || String(v)===""){
    setBadge(secId,q.id,"warn","Chưa chọn");
    return;
  }
  const chosen = Number(v);
  if(state.showAnswers){
    rows.forEach((r,idx)=>{
      if(idx===q.ans) r.classList.add("correct");
      if(idx===chosen && chosen!==q.ans) r.classList.add("wrong");
    });
  }
  const ok = chosen===q.ans;
  setBadge(secId,q.id, ok?"good":"bad", ok?"Đúng":"Sai");
}

function paintFill(secId,q){
  const k = keyOf(secId,q.id);
  const v = state.answers[k];

  if(state.exam.active && !state.exam.submitted){
    setBadge(secId,q.id,"warn", v && String(v).trim() ? "Đã điền" : "—");
    return;
  }
  if(v===undefined || String(v).trim()===""){
    setBadge(secId,q.id,"warn","Chưa điền");
    return;
  }
  const ok = q.ans.includes(String(v).trim());
  setBadge(secId,q.id, ok?"good":"bad", ok?"Đúng":"Sai");
}

function paintReorder(secId,q){
  const k = keyOf(secId,q.id);
  const v = state.answers[k];

  if(state.exam.active && !state.exam.submitted){
    setBadge(secId,q.id,"warn", v ? "Đã sắp" : "—");
    return;
  }
  if(!v){ setBadge(secId,q.id,"warn","Chưa sắp"); return; }
  const joined = String(v).split("|").join("");
  const ok = joined === q.ans.replace(/\s+/g,"");
  setBadge(secId,q.id, ok?"good":"bad", ok?"Đúng":"Sai");
}

function renderQuestion(secId, q){
  const wrap = document.createElement("div");
  wrap.className = "q";

  wrap.innerHTML = `
    <div class="qhead">
      <span class="qnum">${secId}-${q.id}</span>
      <span class="badge" id="badge-${secId}-${q.id}">—</span>
    </div>
    <div class="qtext">${escapeHtml(q.text)}</div>
  `;

  const k = keyOf(secId,q.id);
  const userVal = state.answers[k];

  if(q.type==="mcq"){
    const opts = document.createElement("div");
    opts.className = "opts";

    q.opts.forEach((label,idx)=>{
      const row = document.createElement("label");
      row.className = "opt";
      row.innerHTML = `
        <input type="radio" name="${k}" value="${idx}" ${String(userVal)===String(idx)?"checked":""} />
        <div><b>${String.fromCharCode(65+idx)}.</b> ${escapeHtml(label)}</div>
      `;
      row.addEventListener("click", ()=>{
        if(state.exam.active && state.exam.submitted) return;
        row.querySelector("input").checked = true;
        state.answers[k] = String(idx);
        saveState();
        paintMCQ(secId,q,wrap);
      });
      opts.appendChild(row);
    });
    wrap.appendChild(opts);

    if(state.showAnswers && !(state.exam.active && !state.exam.submitted)){
      const ansLine = document.createElement("div");
      ansLine.className = "hint";
      ansLine.innerHTML = `Đáp án: <b>${String.fromCharCode(65+q.ans)}</b>`;
      wrap.appendChild(ansLine);
    }

    paintMCQ(secId,q,wrap);
    return wrap;
  }

  if(q.type==="fill"){
    const inline = document.createElement("div");
    inline.className = "inline";
    inline.innerHTML = `
      <input type="text" placeholder="Điền 1 từ..." value="${userVal?escapeAttr(userVal):""}" />
      <button class="btn" data-action="check" ${state.exam.active && !state.exam.submitted ? "disabled":""}>Kiểm tra</button>
      <span class="tag" style="display:${state.showAnswers && !(state.exam.active && !state.exam.submitted) ? "inline-flex":"none"}">Đáp án: ${q.ans.join(" / ")}</span>
    `;
    const input = inline.querySelector("input");
    input.addEventListener("input", ()=>{
      if(state.exam.active && state.exam.submitted) return;
      state.answers[k] = input.value;
      saveState();
      paintFill(secId,q);
    });
    inline.querySelector('[data-action="check"]').onclick = ()=> paintFill(secId,q);
    wrap.appendChild(inline);

    paintFill(secId,q);
    return wrap;
  }

  if(q.type==="reorder"){
    const zone = document.createElement("div");
    zone.innerHTML = `
      <div class="dropHint">Kéo thả các mảnh theo thứ tự đúng (kéo lên nhau để đổi vị trí).</div>
      <div class="chipsRow" id="chips-${secId}-${q.id}"></div>
      <div class="inline">
        <button class="btn" data-action="check" ${state.exam.active && !state.exam.submitted ? "disabled":""}>Kiểm tra</button>
        <span class="tag" style="display:${state.showAnswers && !(state.exam.active && !state.exam.submitted) ? "inline-flex":"none"}">Đáp án: ${escapeHtml(q.ans)}</span>
      </div>
    `;
    wrap.appendChild(zone);

    const chipsRow = zone.querySelector(`#chips-${CSS.escape(secId)}-${CSS.escape(String(q.id))}`);

    let tokens = [...q.tokens];
    if(userVal){
      const restored = String(userVal).split("|").filter(Boolean);
      if(restored.length===tokens.length && restored.every(t=>tokens.includes(t))){
        tokens = restored;
      }
    }

    function sync(){
      state.answers[k] = tokens.join("|");
      saveState();
      paintReorder(secId,q);
    }

    function renderChips(){
      chipsRow.innerHTML = "";
      tokens.forEach((t,idx)=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = t;
        chip.draggable = !(state.exam.active && state.exam.submitted);
        chip.dataset.index = String(idx);
        chip.addEventListener("dragstart",(e)=> e.dataTransfer.setData("text/plain", String(idx)));
        chip.addEventListener("dragover",(e)=>{ e.preventDefault(); });
        chip.addEventListener("drop",(e)=>{
          e.preventDefault();
          if(state.exam.active && state.exam.submitted) return;
          const from = Number(e.dataTransfer.getData("text/plain"));
          const to = Number(chip.dataset.index);
          if(Number.isNaN(from)||Number.isNaN(to)||from===to) return;
          const [moved] = tokens.splice(from,1);
          tokens.splice(to,0,moved);
          renderChips();
          sync();
        });
        chipsRow.appendChild(chip);
      });
    }

    renderChips();
    sync();

    zone.querySelector('[data-action="check"]').onclick = ()=> paintReorder(secId,q);
    paintReorder(secId,q);
    return wrap;
  }

  return wrap;
}

function renderExamUI(){
  const banner = document.getElementById("examBanner");
  const startBtn = document.getElementById("startExamBtn");
  const endBtn = document.getElementById("endExamBtn");
  const submitBtn = document.getElementById("submitExamBtn");

  if(state.exam.active){
    banner.style.display = "block";
    startBtn.disabled = true;
    endBtn.style.display = "inline-flex";
    submitBtn.style.display = "inline-flex";

    state.showAnswers = false; // forced off
    document.getElementById("toggleAnswers").disabled = true;

    submitBtn.disabled = !!state.exam.submitted;
    if(state.exam.submitted){
      document.getElementById("toggleAnswers").disabled = false;
    }
    startTimer();
  }else{
    banner.style.display = "none";
    startBtn.disabled = false;
    endBtn.style.display = "none";
    submitBtn.style.display = "none";
    document.getElementById("toggleAnswers").disabled = false;
    stopTimer();
  }
  updateToggles();
}

function render(){
  renderNav();
  updateToggles();
  renderExamUI();

  const sec = SECTIONS.find(s=>s.id===state.sectionId);
  document.getElementById("sectionName").textContent = sec.name;
  document.getElementById("sectionDesc").textContent = sec.desc;

  const tags = document.getElementById("sectionTags");
  tags.innerHTML = "";
  sec.tags.forEach(t=>{
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = t;
    tags.appendChild(span);
  });

  contentEl.innerHTML = "";

  if(!state.exam.active){
    contentEl.appendChild(renderReviewCard(sec));
  }

  if(sec.id==="D"){
    contentEl.appendChild(renderPassage(sec.passage));
    getOrderedIds("D").forEach(id=> contentEl.appendChild(renderQuestion("D", getQuestionById("D", id))));
  }else{
    getOrderedIds(sec.id).forEach(id=> contentEl.appendChild(renderQuestion(sec.id, getQuestionById(sec.id, id))));
  }

  updateKPIs();
}

/* =========================
   EXAM MODE
   ========================= */
let timerTick = null;

function buildExamOrder(){
  const order = {};
  ["A","B","C","D"].forEach(secId=>{
    const ids = getQuestionsInSection(secId).map(q=>q.id);
    order[secId] = shuffle(ids);
  });
  return order;
}
function startExam(durationMin=45){
  state.exam.active = true;
  state.exam.durationMin = durationMin;
  state.exam.startedAt = Date.now();
  state.exam.submitted = false;
  state.exam.order = buildExamOrder();
  state.showAnswers = false;
  state.sectionId = "A";
  saveState();
  render();
}
function endExam(){
  stopTimer();
  state.exam.active = false;
  state.exam.startedAt = null;
  state.exam.submitted = false;
  state.exam.order = null;
  saveState();
  render();
}
function submitExam(){
  state.exam.submitted = true;
  saveState();
  const g = gradeAll();
  alert(`Bạn đã nộp bài!\nĐiểm: ${g.points}/${g.max} (${g.max?Math.round(g.points/g.max*100):0}%)\nGiờ có thể bật “Đáp án” để xem lại.`);
  render();
}
function startTimer(){
  stopTimer();
  timerTick = setInterval(()=>{
    if(!state.exam.active || !state.exam.startedAt) return;
    const totalSec = state.exam.durationMin * 60;
    const elapsedSec = Math.floor((Date.now() - state.exam.startedAt)/1000);
    const left = Math.max(0, totalSec - elapsedSec);
    const mm = String(Math.floor(left/60)).padStart(2,"0");
    const ss = String(left%60).padStart(2,"0");
    document.getElementById("timer").textContent = `⏱ ${mm}:${ss}`;
    if(left<=0 && !state.exam.submitted) submitExam();
  }, 500);
}
function stopTimer(){
  if(timerTick) clearInterval(timerTick);
  timerTick = null;
}

/* =========================
   BUTTONS
   ========================= */
document.getElementById("togglePinyin").onclick = ()=>{
  state.showPinyin = !state.showPinyin;
  saveState(); render();
};
document.getElementById("toggleAnswers").onclick = ()=>{
  if(state.exam.active && !state.exam.submitted) return;
  state.showAnswers = !state.showAnswers;
  saveState(); render();
};
document.getElementById("gradeAll").onclick = ()=>{
  if(state.exam.active && !state.exam.submitted){
    alert("Ôn thi đang bật: chỉ xem điểm sau khi nộp bài.");
    return;
  }
  state.showAnswers = true;
  saveState(); render();
};
document.getElementById("exportJSON").onclick = ()=>{
  const data = {
    exportedAt: new Date().toISOString(),
    sectionId: state.sectionId,
    showPinyin: state.showPinyin,
    showAnswers: state.showAnswers,
    exam: state.exam,
    answers: state.answers
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "hsk_practice_answers.json";
  a.click();
  URL.revokeObjectURL(url);
};
document.getElementById("resetAll").onclick = ()=>{
  if(!confirm("Xoá toàn bộ tiến độ? (Không thể hoàn tác)")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = {
    sectionId: "A",
    showPinyin: true,
    showAnswers: false,
    answers: {},
    exam: { active:false, durationMin:45, startedAt:null, submitted:false, order:null },
    lastSaved: Date.now()
  };
  render();
};
document.getElementById("startExamBtn").onclick = ()=> startExam(45);
document.getElementById("endExamBtn").onclick = ()=> endExam();
document.getElementById("submitExamBtn").onclick = ()=> { if(confirm("Nộp bài ngay bây giờ?")) submitExam(); };

/* =========================
   INIT
   ========================= */
renderNav();
render();
updateKPIs();
</script>
</body>
</html>
