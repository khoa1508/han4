<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ã”n táº­p BÃ i 13 â€“ å¾—/ä¸ bá»• ngá»¯ kháº£ nÄƒng Â· Kinh ká»‹ch ğŸ­</title>
  <style>
    :root{
      --bg:#f7f9fc;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--brand:#6366f1;--brand-2:#22c55e;--danger:#ef4444;--warn:#f59e0b;--shadow:0 10px 30px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#eef2ff,#f0fdfa);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink)}
    header{padding:18px 16px 8px;max-width:1080px;margin:auto}
    .app{max-width:1080px;margin:auto;padding:12px}
    .card{background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:18px}
    h1{font-size:clamp(22px,3vw,30px);margin:0 0 8px}
    .sub{color:var(--muted);font-size:14px}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-top:12px}
    .pill{background:#eef2ff;border-radius:999px;padding:6px 12px;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .timer{background:#ecfeff}
    .score{background:#f0fdf4}
    .level{background:#fff7ed}
    .progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),#7c3aed);width:0%}

    /* Question area */
    .qwrap{margin-top:14px}
    .qtitle{font-size:18px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px}
    .qprompt{font-size:17px}
    .optlist{margin-top:10px;display:grid;gap:10px}
    .opt{border:2px solid #e5e7eb;border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer;background:#fff}
    .opt input{accent-color:var(--brand)}
    .opt.correct{border-color:var(--brand-2);background:#f0fdf4}
    .opt.wrong{border-color:var(--danger);background:#fef2f2}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    button{border:none;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-ghost{background:#eef2ff}
    .btn-warn{background:var(--warn);color:#111}
    .btn-danger{background:#fee2e2;color:#991b1b}

    .feedback{margin-top:10px;border-left:4px solid #e5e7eb;padding:10px 12px;background:#fafafa;border-radius:10px}
    .feedback.good{border-left-color:var(--brand-2);background:#f0fdf4}
    .feedback.bad{border-left-color:var(--danger);background:#fef2f2}

    .badge{display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px dashed #c7d2fe;border-radius:12px;padding:6px 10px}

    .hidden{display:none}

    /* Summary */
    .summary{margin-top:18px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    tr:nth-child(even){background:#fafafa}

    /* Responsive */
    @media (max-width:640px){
      .topbar{grid-template-columns:1fr 1fr;gap:8px}
      .pill{justify-content:center}
      .qprompt{font-size:16px}
      .opt{padding:10px}
    }
  </style>
</head>
<body>
  <header>
    <div class="card">
      <h1>ğŸ¯ Ã”n táº­p BÃ i 13: å¾—/ä¸ bá»• ngá»¯ kháº£ nÄƒng & máº«u cÃ¢u vá» <em>hiá»ƒu/khÃ´ng hiá»ƒu</em></h1>
      <p class="sub">ThÃ¢n thiá»‡n â€“ sinh Ä‘á»™ng â€“ pháº£n há»“i tá»©c thÃ¬. Khi báº¡n tráº£ lá»i xong, â€œAI trá»£ giáº£ngâ€ sáº½ cháº¥m Ä‘iá»ƒm, gá»£i Ã½ ğŸ’¡ vÃ  Ä‘á»™ng viÃªn ğŸ¤—.</p>
      <div class="topbar">
        <div class="pill timer" id="timer">â±ï¸ 00:00</div>
        <div class="pill score" id="scorepill">â­ Äiá»ƒm: <span id="score">0</span></div>
        <div class="pill level" id="levelpill">ğŸ“¶ Cáº¥p: <span id="levelName">â€”</span></div>
      </div>
      <div class="progress" aria-label="tiáº¿n Ä‘á»™" title="Tiáº¿n Ä‘á»™">
        <span id="progressBar"></span>
      </div>
    </div>
  </header>

  <main class="app">
    <section class="card" id="intro">
      <p>ğŸ‘‹ Xin chÃ o! BÃ i chÆ¡i gá»“m nhiá»u cáº¥p Ä‘á»™, tÄƒng dáº§n Ä‘á»™ khÃ³. DÃ¹ng <b>Gá»£i Ã½</b> khi cáº§n (trá»« nháº¹ Ä‘iá»ƒm), hoáº·c <b>Bá» qua</b> Ä‘á»ƒ kiá»ƒm thá»­ tá»«ng pháº§n. ChÃºc báº¡n vui! ğŸ¼</p>
      <ul>
        <li>âš¡ Pháº£n há»“i tá»©c thÃ¬: biáº¿t Ä‘Ãºng/sai ngay.</li>
        <li>â±ï¸ Äá»“ng há»“ cháº¡y xuyÃªn suá»‘t.</li>
        <li>ğŸ… HoÃ n thÃ nh má»—i cáº¥p Ä‘á»ƒ nháº­n huy hiá»‡u.</li>
        <li>ğŸ“ˆ Cuá»‘i bÃ i cÃ³ báº£ng tá»•ng káº¿t chi tiáº¿t.</li>
      </ul>
      <button class="btn-primary" id="startBtn">ğŸš€ Báº¯t Ä‘áº§u</button>
    </section>

    <section class="card hidden" id="game">
      <div class="qwrap">
        <div class="qtitle">ğŸ§© <span id="qtitle">CÃ¢u há»i</span></div>
        <div class="qprompt" id="qprompt"></div>
        <div class="optlist" id="optlist"></div>
        <div id="textAnswer" class="hidden" style="margin-top:10px">
          <input id="textInput" type="text" placeholder="Nháº­p Ä‘Ã¡p Ã¡nâ€¦" style="width:100%;padding:12px;border-radius:12px;border:2px solid #e5e7eb"/>
        </div>
        <div class="actions">
          <button class="btn-primary" id="checkBtn">âœ… Kiá»ƒm tra</button>
          <button class="btn-ghost" id="hintBtn">ğŸ’¡ Gá»£i Ã½</button>
          <button class="btn-warn" id="skipBtn">â­ï¸ Bá» qua</button>
          <button class="btn-ghost" id="nextBtn" disabled>â¡ï¸ Tiáº¿p tá»¥c</button>
        </div>
        <div id="feedback" class="feedback hidden"></div>
        <div style="margin-top:10px" id="badgeSlot"></div>
      </div>
    </section>

    <section class="card hidden" id="summary">
      <h2>ğŸ“Š Tá»•ng káº¿t</h2>
      <p><b>Thá»i gian:</b> <span id="sumTime"></span> Â· <b>Äiá»ƒm:</b> <span id="sumScore"></span> Â· <b>ÄÃºng:</b> <span id="sumRight"></span> Â· <b>Sai:</b> <span id="sumWrong"></span> Â· <b>Bá» qua:</b> <span id="sumSkip"></span></p>
      <div class="badge">ğŸ† Huy hiá»‡u: <span id="sumBadges" style="margin-left:6px"></span></div>
      <div class="summary" style="margin-top:14px">
        <table>
          <thead>
            <tr><th>#</th><th>CÃ¢u há»i</th><th>ÄÃ¡p Ã¡n cá»§a báº¡n</th><th>ÄÃ¡p Ã¡n Ä‘Ãºng</th><th>Káº¿t quáº£</th></tr>
          </thead>
          <tbody id="sumTable"></tbody>
        </table>
      </div>
      <div class="actions" style="margin-top:14px">
        <button class="btn-primary" onclick="location.reload()">ğŸ” ChÆ¡i láº¡i</button>
      </div>
    </section>
  </main>

  <script>
  // ====== Data (cÃ³ thá»ƒ má»Ÿ rá»™ng tÃ¹y ná»™i dung bÃ i giáº£ng) ======
  // Cáº¥p 1: Tá»ª Vá»°NG â€“ láº¥y tá»« há»™i thoáº¡i Kinh ká»‹ch
  const level1 = {
    id: 'vocab',
    name: 'Tá»« vá»±ng vui ğŸˆ',
    intro: 'Chá»n nghÄ©a Ä‘Ãºng cho tá»« HÃ¡n ngá»¯.',
    badge: 'ğŸ§  Tá»« vá»±ng thá»§',
    questions: [
      {type:'mcq', prompt:'â€œäº¬å‰§â€ nghÄ©a lÃ  gÃ¬?', options:['Nháº¡c rap','Kinh ká»‹ch (Peking Opera)','Ká»‹ch cÃ¢m'], answer:'Kinh ká»‹ch (Peking Opera)', hint:'Nghá»‡ thuáº­t truyá»n thá»‘ng ná»•i tiáº¿ng cá»§a Trung Quá»‘c.', explain:'äº¬å‰§ = Kinh ká»‹ch â€“ nghá»‡ thuáº­t sÃ¢n kháº¥u truyá»n thá»‘ng Trung Quá»‘c.'},
      {type:'mcq', prompt:'â€œè„¸è°±â€ lÃ â€¦', options:['Máº·t náº¡/hoáº¡ máº·t nhÃ¢n váº­t','Báº£n Ä‘á»“ khuÃ´n máº·t','MÃ¡y áº£nh chá»¥p chÃ¢n dung'], answer:'Máº·t náº¡/hoáº¡ máº·t nhÃ¢n váº­t', hint:'DÃ¹ng Ä‘á»ƒ thá»ƒ hiá»‡n tÃ­nh cÃ¡ch, Ä‘á»‹a vá»‹ nhÃ¢n váº­t.', explain:'äº¬å‰§è„¸è°± dÃ¹ng mÃ u sáº¯c/hoa vÄƒn Ä‘á»ƒ biá»ƒu hiá»‡n tÃ­nh cÃ¡ch, thÃ¢n pháº­n.'},
      {type:'mcq', prompt:'â€œæ­¦æ‰“â€ trong ngá»¯ cáº£nh Kinh ká»‹ch lÃ â€¦', options:['Ã‚m nháº¡c ná»n','Äá»™ng tÃ¡c vÃµ thuáº­t','Tiáº¿u lÃ¢m'], answer:'Äá»™ng tÃ¡c vÃµ thuáº­t', hint:'CÃ¡c Ä‘á»™ng tÃ¡c biá»ƒu diá»…n máº¡nh máº½ trÃªn sÃ¢n kháº¥u.', explain:'æ­¦æ‰“ = vÃµ thuáº­t/sáº¯c thÃ¡i hÃ nh Ä‘á»™ng trong biá»ƒu diá»…n.'},
      {type:'mcq', prompt:'â€œæ¼”å‡ºâ€ nghÄ©a lÃ â€¦', options:['Buá»•i biá»ƒu diá»…n','Há»c bá»•ng','Tá»± há»c'], answer:'Buá»•i biá»ƒu diá»…n', hint:'Báº¡n mua vÃ© Ä‘á»ƒ xem cÃ¡i nÃ y.', explain:'æ¼”å‡º = biá»ƒu diá»…n, suáº¥t diá»…n.'},
      {type:'mcq', prompt:'â€œæœè£…â€ nghÄ©a lÃ â€¦', options:['Trang phá»¥c','Phá»¥ kiá»‡n Ä‘iá»‡n tá»­','SÃ¡ch vá»Ÿ'], answer:'Trang phá»¥c', hint:'Äá»“ máº·c cá»§a diá»…n viÃªn trÃªn sÃ¢n kháº¥u.', explain:'æœè£… = quáº§n Ã¡o, trang phá»¥c.'},
      {type:'mcq', prompt:'â€œå½±å“â€ lÃ â€¦', options:['áº¢nh hÆ°á»Ÿng','CÆ¡n giÃ³','Ãnh Ä‘Ã¨n'], answer:'áº¢nh hÆ°á»Ÿng', hint:'Tháº§y cÃ´ cÃ³ thá»ƒ cÃ³ Ä‘iá»u nÃ y vá»›i há»c sinh.', explain:'å½±å“ = áº£nh hÆ°á»Ÿng, tÃ¡c Ä‘á»™ng.'},
    ]
  };

  // Cáº¥p 2: MáºªU CÃ‚U å¾—/ä¸ + bá»• ngá»¯ (kháº£ nÄƒng)
  const level2 = {
    id: 'pattern',
    name: 'Máº«u cÃ¢u âœï¸',
    intro: 'Chá»n/cáº­p nháº­t cáº¥u trÃºc Ä‘Ãºng theo ngá»¯ cáº£nh (V + å¾—/ä¸ + bá»• ngá»¯).',
    badge: 'ğŸ§© GhÃ©p máº«u cÃ¢u',
    questions: [
      {type:'mcq', prompt:'æˆ‘____äº¬å‰§ã€‚TÃ´i khÃ´ng thá»ƒ nghe hiá»ƒu Kinh ká»‹ch.', options:['å¬å¾—æ‡‚','å¬ä¸æ‡‚','çœ‹å¾—æ‡‚'], answer:'å¬ä¸æ‡‚', hint:'Phá»§ Ä‘á»‹nh kháº£ nÄƒng: V + ä¸ + è¡¥è¯­ã€‚', explain:'å¬ä¸æ‡‚ = khÃ´ng nghe hiá»ƒu.'},
      {type:'mcq', prompt:'ç¥¨å¥½ä¹°ï¼Œè‚¯å®š____ã€‚Báº¡n Ä‘á»«ng lo, cháº¯c cháº¯n mua Ä‘Æ°á»£c vÃ©.', options:['ä¹°å¾—åˆ°','ä¹°ä¸åˆ°','ä¹°ä¸å®Œ'], answer:'ä¹°å¾—åˆ°', hint:'Kháº³ng Ä‘á»‹nh kháº£ nÄƒng: V + å¾— + è¡¥è¯­ã€‚', explain:'ä¹°å¾—åˆ° = cÃ³ thá»ƒ mua Ä‘Æ°á»£c.'},
      {type:'mcq', prompt:'ä»Šå¤©ä½œä¸šå¤ªå¤šï¼Œæˆ‘ä¸€ä¸ªå°æ—¶____ã€‚BÃ i nhiá»u, 1h khÃ´ng xong.', options:['åšå¾—å®Œ','åšä¸å®Œ','åšå¾—äº†'], answer:'åšä¸å®Œ', hint:'Phá»§ Ä‘á»‹nh kháº£ nÄƒng thÆ°á»ng dÃ¹ng nhiá»u.', explain:'åšä¸å®Œ = lÃ m khÃ´ng xong.'},
      {type:'mcq', prompt:'å±‹å­é‡Œå¤ªé»‘ï¼Œæˆ‘____ã€‚Trong phÃ²ng tá»‘i quÃ¡, tÃ´iâ€¦', options:['çœ‹ä¸è§','ä¸èƒ½çœ‹è§','çœ‹ä¸å¾—'], answer:'çœ‹ä¸è§', hint:'Thiáº¿u Ä‘iá»u kiá»‡n khÃ¡ch quan â†’ dÃ¹ng bá»• ngá»¯ kháº£ nÄƒng.', explain:'çœ‹ä¸è§ (khÃ´ng nhÃ¬n tháº¥y) tá»± nhiÃªn hÆ¡n ä¸èƒ½çœ‹è§.'},
      {type:'mcq', prompt:'è¿™ä¸ªåŒ…å¤ªå°ï¼Œæ¯›è¡£å¤ªå¤§äº†ï¼Œ____ã€‚TÃºi quÃ¡ nhá», Ã¡o len quÃ¡ toâ€¦', options:['è£…å¾—ä¸‹','è£…ä¸ä¸‹','åä¸ä¸‹'], answer:'è£…ä¸ä¸‹', hint:'NÃ³i vá» chá»©a/nhÃ©t Ä‘Æ°á»£c hay khÃ´ng: å¾—ä¸‹/ä¸ä¸‹', explain:'è£…ä¸ä¸‹ = khÃ´ng Ä‘á»±ng vá»«a.'},
      {type:'mcq', prompt:'ä»–è…¿æ‘”ä¼¤äº†ï¼Œè‡ªå·±____ã€‚ChÃ¢n bá»‹ thÆ°Æ¡ng, tá»± mÃ¬nhâ€¦', options:['èµ°å¾—äº†','èµ°ä¸äº†','èƒ½èµ°'], answer:'èµ°ä¸äº†', hint:'å¾—äº†/ä¸äº†: phÃ¡t sinh/hoÃ n thÃ nh Ä‘á»™ng tÃ¡c Ä‘Æ°á»£c khÃ´ng.', explain:'èµ°ä¸äº† = khÃ´ng tá»± Ä‘i Ä‘Æ°á»£c.'}
    ]
  };

  // Cáº¥p 3: PHÃ‚N BIá»†T èƒ½/å¯ä»¥ vs è¡¥è¯­èƒ½åŠ›
  const level3 = {
    id: 'grammar',
    name: 'Ngá»¯ phÃ¡p âš–ï¸',
    intro: 'Chá»n phÆ°Æ¡ng Ã¡n tá»± nhiÃªn/Ä‘Ãºng hÆ¡n trong ngá»¯ cáº£nh.',
    badge: 'ğŸ“š Ngá»¯ phÃ¡p thá»§',
    questions: [
      {type:'mcq', prompt:'é‚£å„¿å¤ªå±é™©ï¼Œä½ __å»ã€‚á» Ä‘Ã³ nguy hiá»ƒm, báº¡n khÃ´ng thá»ƒ Ä‘i.', options:['ä¸èƒ½','å»ä¸äº†'], answer:'ä¸èƒ½', hint:'KhuyÃªn/ra lá»‡nh: ä¸èƒ½ + V', explain:'Cáº¥m/ngÄƒn: ä¸èƒ½å» tá»± nhiÃªn hÆ¡n å»ä¸äº†.'},
      {type:'mcq', prompt:'ä»Šå¤©æœ‰æ—¶é—´ï¼Œæˆ‘__å»ã€‚HÃ´m nay ráº£nh, tÃ´i cÃ³ thá»ƒ Ä‘i.', options:['èƒ½','å»å¾—äº†'], answer:'èƒ½', hint:'NÃ³i nÄƒng lá»±c/Ä‘iá»u kiá»‡n chá»§ quan â†’ èƒ½/å¯ä»¥.', explain:'â€œèƒ½å»â€ phÃ¹ há»£p; â€œå»å¾—äº†â€ cÅ©ng cÃ³ thá»ƒ dÃ¹ng, song cÃ¡ch thÆ°á»ng gáº·p lÃ  èƒ½/å¯ä»¥.'},
      {type:'mcq', prompt:'å¦‚æœæ²¡æœ‰ç¥¨ï¼Œæˆ‘ä»¬å°±__å‰§åœºã€‚Náº¿u khÃ´ng cÃ³ vÃ© thÃ¬ khÃ´ng â€¦ vÃ o.', options:['è¿›ä¸äº†','ä¸èƒ½è¿›å¾—å»'], answer:'è¿›ä¸äº†', hint:'Bá»• ngá»¯ kháº£ nÄƒng vá»›i Ä‘iá»u kiá»‡n khÃ¡ch quan (vÃ©).', explain:'è¿›ä¸äº† = khÃ´ng vÃ o Ä‘Æ°á»£c.'},
      {type:'mcq', prompt:'é»‘æ¿ä¸Šçš„å­—ä½ __ï¼ŸChá»¯ trÃªn báº£ng báº¡n cÃ³ nhÃ¬n rÃµ khÃ´ng?', options:['çœ‹å¾—æ¸…æ¥šçœ‹ä¸æ¸…æ¥š','èƒ½ä¸èƒ½çœ‹æ¸…æ¥š'], answer:'çœ‹å¾—æ¸…æ¥šçœ‹ä¸æ¸…æ¥š', hint:'Máº«u há»i chÃ­nh-pháº£n vá»›i å¾—/ä¸.', explain:'A-not-A dÃ¹ng å¾—/ä¸ Ä‘Ãºng máº«u: çœ‹å¾—æ¸…æ¥šçœ‹ä¸æ¸…æ¥šï¼Ÿ'},
      {type:'mcq', prompt:'è¿™å„¿å¤ªæŒ¤äº†ï¼Œ____åä¸ªäººã€‚á» Ä‘Ã¢y cháº­t quÃ¡, (khÃ´ng) ngá»“i vá»«a 10 ngÆ°á»i.', options:['åä¸ä¸‹','ä¸èƒ½å'], answer:'åä¸ä¸‹', hint:'KhÃ´ng gian chá»©a: å¾—ä¸‹/ä¸ä¸‹', explain:'åä¸ä¸‹ nÃ³i vá» sá»©c chá»©a.'},
      {type:'mcq', prompt:'æˆ‘__ä¸€ä¸ªå°æ—¶å°±å®Œæˆäº†ã€‚TÃ´i khÃ´ng cáº§n háº¿t 1h lÃ  xong.', options:['ç”¨ä¸äº†','ä¸èƒ½ç”¨'], answer:'ç”¨ä¸äº†', hint:'å¾—äº†/ä¸äº† chá»‰ má»©c Ä‘á»™/nhu cáº§u thá»i gian.', explain:'ç”¨ä¸äº† = khÃ´ng cáº§n dÃ¹ng/khÃ´ng máº¥t Ä‘áº¿n (bao nhiÃªu).'}
    ]
  };

  // Cáº¥p 4: Äá»ŒC HIá»‚U â€“ trÃ­ch Ä‘oáº¡n há»™i thoáº¡i/ghi chÃ©p
  const level4 = {
    id: 'reading',
    name: 'Äá»c hiá»ƒu ğŸ“–',
    intro: 'Äá»c Ä‘oáº¡n trÃ­ch vÃ  tráº£ lá»i.',
    badge: 'ğŸ” ThÃ¡m tá»­ Ä‘á»c hiá»ƒu',
    passage: 'ç›ä¸½ï¼šä½ çœ‹è¿‡äº¬å‰§å—ï¼Ÿ\nå±±æœ¬ï¼šçœ‹è¿‡ä¸€æ¬¡ã€‚\nç›ä¸½ï¼šçœ‹å¾—æ‡‚å—ï¼Ÿ\nå±±æœ¬ï¼šçœ‹å¾—æ‡‚ï¼Œä½†æ˜¯å¬ä¸æ‡‚ã€‚çœ‹äº†æ¼”å‡ºèƒ½çŒœå¾—å‡ºå¤§æ¦‚çš„æ„æ€ã€‚\næ˜¨å¤©æˆ‘ç»™å±±æœ¬æ‰“ç”µè¯ï¼Œçº¦å¥¹æ™šä¸Šä¸€èµ·å»çœ‹äº¬å‰§ã€‚ä½†æ˜¯å¥¹è¯´æ™šä¸Šæœ‰äº‹ï¼Œå»ä¸äº†ã€‚æ‰€ä»¥æˆ‘ä»¬å°±å†³å®šä»Šå¤©æ™šä¸Šå»ã€‚æˆ‘ä»¬æ˜¯ä¸‹åˆäº”ç‚¹åŠå‡ºå‘çš„ã€‚å±±æœ¬å¸Œæœ›èƒ½ä¹°åˆ°å‰åæ’çš„â€¦æœ€åä¹°åˆ°çš„æ˜¯åäºŒæ’çš„ç¥¨ã€‚',
    questions: [
      {type:'mcq', prompt:'å±±æœ¬çœ‹è¿‡äº¬å‰§å‡ æ¬¡ï¼Ÿ', options:['ä¸€æ¬¡','ä¸¤æ¬¡','å¾ˆå¤šæ¬¡'], answer:'ä¸€æ¬¡', hint:'çœ‹è¿‡ä¸€æ¬¡ = Ä‘Ã£ xem má»™t láº§n.', explain:'â€œä¸€æ¬¡â€ = 1 láº§n.'},
      {type:'mcq', prompt:'ä»–ä»¬ä¸ºä»€ä¹ˆæ˜¨å¤©æ²¡å»çœ‹ï¼Ÿ', options:['ä¹°ä¸åˆ°ç¥¨','æ™šä¸Šæœ‰äº‹ï¼Œå»ä¸äº†','ä¸‹é›¨äº†'], answer:'æ™šä¸Šæœ‰äº‹ï¼Œå»ä¸äº†', hint:'å»ä¸äº† = khÃ´ng thá»ƒ Ä‘i.', explain:'VÃ¬ tá»‘i qua báº­n viá»‡c.'},
      {type:'mcq', prompt:'ä»–ä»¬å‡ ç‚¹å‡ºå‘ï¼Ÿ', options:['äº”ç‚¹','äº”ç‚¹åŠ','ä¸ƒç‚¹åŠ'], answer:'äº”ç‚¹åŠ', hint:'â€œæˆ‘ä»¬æ˜¯ä¸‹åˆäº”ç‚¹åŠå‡ºå‘çš„ã€‚â€', explain:'5:30 chiá»u.'},
      {type:'mcq', prompt:'ä»–ä»¬æœ€åä¹°åˆ°äº†ç¬¬__æ’çš„ç¥¨ã€‚', options:['å','åäºŒ','äºŒå'], answer:'åäºŒ', hint:'å‰åæ’å–å®Œ â†’ åäºŒæ’ã€‚', explain:'Mua gháº¿ hÃ ng 12.'},
      {type:'mcq', prompt:'â€œçœ‹å¾—æ‡‚ï¼Œä½†æ˜¯å¬ä¸æ‡‚â€è¡¨è¾¾äº†ä»€ä¹ˆï¼Ÿ', options:['å®Œå…¨ä¸æ‡‚','èƒ½çœ‹æ‡‚å¤§æ¦‚æ„æ€ï¼Œä½†å¬ä¸æ‡‚å”±è¯','éƒ½æ‡‚'], answer:'èƒ½çœ‹æ‡‚å¤§æ¦‚æ„æ€ï¼Œä½†å¬ä¸æ‡‚å”±è¯', hint:'å¾—/ä¸ è¡¨ kháº£ nÄƒng.', explain:'NhÃ¬n hiá»ƒu Ä‘áº¡i Ã½, nhÆ°ng khÃ´ng nghe hiá»ƒu lá»i hÃ¡t.'}
    ]
  };

  const LEVELS = [level1, level2, level3, level4];

  // ====== State ======
  const state = {
    started:false, startTime:null, timerId:null,
    levelIndex:0, qIndex:0, score:0,
    answers:[], // {lvl, idx, user, correct, right}
    usedHint:false,
    badges:[],
  };

  // ====== Helpers ======
  const $ = sel => document.querySelector(sel);
  const fmtTime = secs => {
    const m = Math.floor(secs/60).toString().padStart(2,'0');
    const s = (secs%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  };

  function startTimer(){
    state.startTime = Date.now();
    state.timerId = setInterval(()=>{
      const t = Math.floor((Date.now()-state.startTime)/1000);
      $('#timer').textContent = 'â±ï¸ ' + fmtTime(t);
    }, 500);
  }

  function currentLevel(){return LEVELS[state.levelIndex];}
  function currentQuestion(){return currentLevel().questions[state.qIndex];}

  function updateTop(){
    $('#score').textContent = state.score;
    $('#levelName').textContent = `${state.levelIndex+1}/${LEVELS.length} â€“ ${currentLevel().name}`;
    const done = state.qIndex, total = currentLevel().questions.length;
    const pct = Math.round((done/total)*100);
    $('#progressBar').style.width = pct + '%';
  }

  function renderQuestion(){
    const lvl = currentLevel();
    const q = currentQuestion();
    $('#qtitle').textContent = `${lvl.name} Â· CÃ¢u ${state.qIndex+1}/${lvl.questions.length}`;
    const promptHTML = [];
    if(lvl.passage && state.qIndex===0){
      promptHTML.push(`<div class="card" style="background:#f8fafc;border:1px solid #e5e7eb;margin-bottom:10px">ğŸ“œ <b>Äoáº¡n trÃ­ch</b><pre style="white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace">${lvl.passage}</pre></div>`);
    }
    promptHTML.push(q.prompt);
    $('#qprompt').innerHTML = promptHTML.join('');

    $('#feedback').classList.add('hidden');
    $('#badgeSlot').innerHTML='';

    // options or text
    const optlist = $('#optlist');
    optlist.innerHTML='';
    $('#textAnswer').classList.add('hidden');

    if(q.type==='mcq'){
      q.options.forEach((opt,i)=>{
        const id=`opt${i}`;
        const el=document.createElement('label');
        el.className='opt';
        el.innerHTML=`<input type="radio" name="choice" value="${opt}"><span>${opt}</span>`;
        optlist.appendChild(el);
      });
    } else if(q.type==='text'){
      $('#textAnswer').classList.remove('hidden');
      $('#textInput').value='';
    }

    $('#nextBtn').disabled=true;
    state.usedHint=false;
  }

  function getUserAnswer(){
    const q=currentQuestion();
    if(q.type==='mcq'){
      const checked=document.querySelector('input[name="choice"]:checked');
      return checked?checked.value:null;
    }else{
      return $('#textInput').value.trim();
    }
  }

  function normalize(str){
    return (str||'').replace(/\s+/g,'').toLowerCase();
  }

  function checkAnswer(isSkip=false){
    const q=currentQuestion();
    let user = isSkip? null : getUserAnswer();
    const feedback=$('#feedback');
    feedback.classList.remove('hidden','good','bad');

    let right=false, correctAns=q.answer;
    if(isSkip){
      feedback.classList.add('bad');
      feedback.innerHTML = `ğŸ¤– <b>AI trá»£ giáº£ng:</b> MÃ¬nh sáº½ bá» qua cÃ¢u nÃ y Ä‘á»ƒ báº¡n kiá»ƒm thá»­ pháº§n khÃ¡c. ÄÃ¡p Ã¡n Ä‘Ãºng lÃ : <b>${correctAns}</b>. ${q.explain?('<br>'+q.explain):''}`;
    } else if(user==null || user===''){
      feedback.classList.add('bad');
      feedback.textContent='ğŸ¤– HÃ£y chá»n/nháº­p Ä‘Ã¡p Ã¡n nhÃ©!';
      return; // do not proceed
    } else {
      if(Array.isArray(correctAns)){
        right = correctAns.map(normalize).includes(normalize(user));
      } else {
        right = normalize(user)===normalize(correctAns);
      }
      if(q.type==='mcq'){
        // mark options
        document.querySelectorAll('.opt').forEach(l=>{
          const val = l.querySelector('input').value;
          if(normalize(val)===normalize(correctAns)) l.classList.add('correct');
          if(val===user && !right) l.classList.add('wrong');
        });
      }

      if(right){
        const bonus = 10 - (state.usedHint?2:0);
        state.score += Math.max(1, bonus);
        feedback.classList.add('good');
        feedback.innerHTML = `ğŸ‰ ChÃ­nh xÃ¡c! +${Math.max(1,bonus)} Ä‘iá»ƒm. ${q.explain?('<br>'+q.explain):''}`;
      } else {
        feedback.classList.add('bad');
        feedback.innerHTML = `ğŸ§ ChÆ°a Ä‘Ãºng. ÄÃ¡p Ã¡n lÃ  <b>${correctAns}</b>. ${q.explain?('<br>'+q.explain):''}`;
      }
    }

    state.answers.push({lvl:state.levelIndex, idx:state.qIndex, user, correct:correctAns, right});
    $('#nextBtn').disabled=false;
    updateTop();
  }

  function nextStep(){
    const lvl=currentLevel();
    if(state.qIndex < lvl.questions.length-1){
      state.qIndex++;
      renderQuestion();
      updateTop();
      return;
    }
    // level finished â†’ badge
    const levelAnswers = state.answers.filter(a=>a.lvl===state.levelIndex);
    const rightCount = levelAnswers.filter(a=>a.right).length;
    const ratio = rightCount / lvl.questions.length;
    let earned = '';
    if(ratio>=0.8){ earned = `${lvl.badge} ğŸ’`; }
    else if(ratio>=0.6){ earned = `${lvl.badge} ğŸ¥ˆ`; }
    else { earned = `${lvl.badge} ğŸ–ï¸`; }
    state.badges.push(earned);
    $('#badgeSlot').innerHTML = `<span class="badge">ğŸ… Báº¡n nháº­n Ä‘Æ°á»£c huy hiá»‡u: <b>${earned}</b></span>`;

    // auto proceed to next level after short delay
    setTimeout(()=>{
      if(state.levelIndex < LEVELS.length-1){
        state.levelIndex++;
        state.qIndex=0;
        renderQuestion();
        updateTop();
      } else {
        finishGame();
      }
    }, 1000);
  }

  function showHint(){
    const q=currentQuestion();
    const feedback=$('#feedback');
    feedback.classList.remove('hidden','good');
    feedback.classList.add('bad');
    const penalty = feedback.dataset.hinted? 0 : 2; // only deduct once per question
    if(!feedback.dataset.hinted){
      state.score = Math.max(0, state.score - penalty);
      feedback.dataset.hinted = '1';
      state.usedHint=true;
      updateTop();
    }
    feedback.innerHTML = `ğŸ’¡ Gá»£i Ã½: ${q.hint || 'Thá»­ Ä‘á»c ká»¹ láº¡i ngá»¯ cáº£nh nhÃ©!'} ${penalty?`(âˆ’${penalty} Ä‘iá»ƒm)`:''}`;
  }

  function finishGame(){
    clearInterval(state.timerId);
    $('#game').classList.add('hidden');
    $('#summary').classList.remove('hidden');

    // totals
    const secs = Math.floor((Date.now()-state.startTime)/1000);
    const right = state.answers.filter(a=>a.right).length;
    const wrong = state.answers.filter(a=>a.user!==null && !a.right).length;
    const skip = state.answers.filter(a=>a.user===null).length;

    $('#sumTime').textContent = fmtTime(secs);
    $('#sumScore').textContent = state.score;
    $('#sumRight').textContent = right;
    $('#sumWrong').textContent = wrong;
    $('#sumSkip').textContent = skip;
    $('#sumBadges').textContent = state.badges.join(' Â· ');

    // table
    const tbody = $('#sumTable');
    tbody.innerHTML='';
    state.answers.forEach((a,i)=>{
      const lvl = LEVELS[a.lvl];
      const q = lvl.questions[a.idx];
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${q.prompt}</td><td>${a.user===null?'â­ï¸ Bá» qua':a.user}</td><td>${Array.isArray(a.correct)?a.correct.join(' / '):a.correct}</td><td>${a.right?'âœ… ÄÃºng':'âŒ Sai'}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ====== Init & Events ======
  $('#startBtn').addEventListener('click',()=>{
    state.started=true; startTimer();
    $('#intro').classList.add('hidden');
    $('#game').classList.remove('hidden');
    state.levelIndex=0; state.qIndex=0; state.score=0; state.answers=[]; state.badges=[];
    renderQuestion(); updateTop();
  });

  $('#checkBtn').addEventListener('click',()=>checkAnswer(false));
  $('#skipBtn').addEventListener('click',()=>checkAnswer(true));
  $('#nextBtn').addEventListener('click',nextStep);
  $('#hintBtn').addEventListener('click',showHint);
  </script>
</body>
</html>
